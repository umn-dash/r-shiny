<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>R Shiny: DTs and Leaflets and Plotlys, Oh my!</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="manifest" href="../site.webmanifest"><link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../shiny_4.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      R Shiny
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            R Shiny
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  R Shiny
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 63%" class="percentage">
    63%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 63%" aria-valuenow="63" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../shiny_4.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="shiny_1.html">1. Welcome to the Web!</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="shiny_2.html">2. Building the Ground Floor of a Shiny App</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="shiny_3.html">3. R Shiny's Core Concepts: Rendering and Outputting, Input widgets, and Reactivity</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        4. DTs and Leaflets and Plotlys, Oh my!
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#turning-the-tables">Turning the tables</a></li>
<li><a href="#update-dont-remake-dt-edition">Update, don’t remake, DT edition!</a></li>
<li><a href="#getting-graphic">Getting graphic</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/shiny_3.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/index.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/shiny_3.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: R Shiny's Core
        </a>
        <a class="chapter-link float-end" href="../instructor/index.html" rel="next">
          Home
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>DTs and Leaflets and Plotlys, Oh my!</h1>
        <p>Last updated on 2024-08-29 |

        <a href="https://github.com/carpentries/r_shiny_workshop/edit/main/episodes/shiny_4.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 70 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How do I add an interactive map/table/graph to my app?</li>
<li>What features do these widgets have?</li>
<li>How do I adjust the aesthetics of these widgets?</li>
<li>How can I modify these widgets to handle user actions without
“starting over?”</li>
<li>What events related to these widgets can I watch for, and how would
I handle them?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Name essential tools from the <code>DT</code>, <code>leaflet</code>
and <code>plotly</code> packages.</li>
<li>Experiment with the interactive features baked into the
plots/tables/maps produced by these packages.</li>
<li>Customize the look and feel of these complex interactive
graphics.</li>
<li>Update complex interactive graphics instead of remaking them when
possible by using <strong>proxies</strong>.</li>
<li>Recognize events a user might trigger with respect to these complex
interactive graphics, and know how to watch for and handle them.</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="disclaimer">Disclaimer<a class="anchor" aria-label="anchor" href="#disclaimer"></a></h3>
<p><em>At points in this lesson, the example code produces
<strong>warnings</strong> (not <strong>errors</strong>!) when executed.
These can be ignored!</em></p>
</div>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a></h3>
<p>While <strong>input widgets</strong> like drop-down menus and buttons
are powerful ways to give users control, they aren’t always
transformative <em>by themselves</em>. There are <em>much</em> more
powerful widgets out there!</p>
<p>And, since our app’s server side is powered by R—a programming
language <em>designed for</em> data work—it make senses we’d include
widgets that put <em>data</em> at our users’ fingertips in interesting
ways.</p>
<p>Of all the data-centered widgets, few are more familiar than
<strong>tables</strong>, <strong>maps</strong>, and
<strong>graphs</strong>. Because these are <em>so</em> ubiquitous, it
probably won’t surprise you that there are JavaScript-native packages
for creating web-enabled, interactive versions of these graphic
types.</p>
<p>While there are other such packages, here we’ll explore
<code>DT</code> (for tables), <code>leaflet</code> (for maps), and
<code>plotly</code> (for graphs), since each has been ported into R + R
Shiny via packages of the same names.</p>
<p>Each of these could <em>easily</em> be a course unto itself! As such,
we’ll look <em>only</em> at the cross-cutting basics—greater depth can
be found elsewhere once you’ve learned the ropes.</p>
<p>Learning <code>leaflet</code> and <code>plotly</code>, specifically,
come with challenges we’ll have to skirt around:</p>
<ul><li><p><code>leaflet</code> builds maps, which represent <strong>spatial
data</strong>. These, and the packages that work with them
(<em>e.g.</em>, <code>sf</code>), are <em>complicated</em>! I’ll gloss
over the details, but we’ll still need to occasionally borrow tools from
<code>sf</code> to accomplish anything at all.</p></li>
<li><p>If you’re familiar with <code>ggplot2</code> (or a comparable
data viz package), you already know that learning programmatica
graph-making has a steep learning curve. <code>plotly</code> has the
same curve (perhaps even a steeper one for R users, since it’s
<em>very</em> JavaScript-like, whereas <code>ggplot2</code> is more
R-like). Again, I’ll gloss over the details, but even the basics may be
a heavy lift for some.</p></li>
</ul><p>Let’s start simple—let’s swap out our functional but drab table for a
better, <code>DT</code> table. Of the packages we’re learning here,
<code>DT</code> is easiest (IMHO), and it can introduce us to all the
key concepts we’ll need to tackle <code>leaflet</code> and
<code>plotly</code>.</p>
</div>
<section><h2 class="section-heading" id="turning-the-tables">Turning the tables<a class="anchor" aria-label="anchor" href="#turning-the-tables"></a></h2>
<hr class="half-width"><div class="section level3">
<h3 id="basic-table">Basic table<a class="anchor" aria-label="anchor" href="#basic-table"></a></h3>
<p>All we have to do to swap our tables is change our
<code>renderTable({})</code> and <code>tableOutput()</code> calls into
<code>renderDT({})</code> and <code>dataTableOutput()</code> calls,
which yield a <code>DT</code> table instead:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** ALL table-related code contained within your server.R file!</span></span>
<span></span>
<span><span class="co">###BASIC GAPMINDER TABLE</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_table</span> <span class="op">=</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span> <span class="co">#&lt;--ONLY CHANGES HERE.</span></span>
<span>    <span class="va">gap</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co">##TABLE OBSERVER (BUTTON)</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">go_button</span>, <span class="op">{</span> </span>
<span></span>
<span>    <span class="va">output</span><span class="op">$</span><span class="va">basic_table</span> <span class="op">=</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span> <span class="co">#&lt;--...AND HERE.</span></span>
<span>      <span class="va">gap</span> <span class="op">%&gt;%</span> </span>
<span>        <span class="fu">arrange</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">sorted_column</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the content of the "main panel" cell within the BODY section of your ui.R file!</span></span>
<span></span>
<span><span class="co">##... other UI code...</span></span>
<span></span>
<span><span class="co">###MAIN PANEL CELL</span></span>
<span>    <span class="fu">column</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">8</span>, <span class="fu">tabsetPanel</span><span class="op">(</span></span>
<span>      <span class="co">###TABLE TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Table"</span>, </span>
<span>               <span class="fu">dataTableOutput</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span><span class="op">)</span>, <span class="co">#&lt;--ONLY CHANGE HERE</span></span>
<span>      <span class="co">###MAP TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Map"</span><span class="op">)</span>,</span>
<span>      <span class="co">###GRAPH TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Graph"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>   <span class="op">)</span></span>
<span></span>
<span><span class="co">##... other UI code...</span></span></code></pre>
</div>
<p>Once you’ve made those swaps, restart your app.</p>
<p>When you do, you’ll <em>immediately</em> notice our table looks
<em>very</em> different:</p>
<figure><img src="../fig/DT%20table%20features.png" alt="The DT table above shows off several of the features that come standard, including pagination, searching, row selection, and column sorting." class="figure mx-auto d-block"><div class="figcaption">The DT table above shows off several of the
features that come standard, including pagination, searching, row
selection, and column sorting.</div>
</figure><ul><li><p>It’s <strong>paginated</strong>, <em>i.e.</em>,“divided into
pages.” Users flip pages using buttons in the bottom-right. Users can
also change page length using a drop-down menu in the top-left. These
features allow users to limit how much data is shown at once, and they
also keep the table from being long vertically if there’s a lot of data
to show.</p></li>
<li><p>It’s <strong>searchable</strong>—users can type
<strong>strings</strong> (chunks of letters/numbers/symbols) into the
search box in the upper-right; the table will filter to only rows
containing that string in any column.</p></li>
<li><p>It’s <strong>sortable</strong>—users can click the up/down arrows
next to each column name to sort the table by that column. You’ll note
this functionality makes our drop-down menu a bit redundant!</p></li>
<li><p>It’s (modestly) styled—it’s snazzier than our previous table
because it comes with <em>some</em> automatic CSS (bolded column names
and row “zebra striping,” as two examples).<br><br>
[Side-note: Web developers call elements with pre-set CSS
<strong>opinionated</strong>. Opinionated elements are nice in that they
often require less custom styling, but if you do choose to restyle them,
it can be hard to overcome their “opinions.”]</p></li>
<li><p>It’s <strong>selectable</strong>—users can click to highlight
(“select”) rows. This <strong>event</strong> doesn’t actually do
anything by default besides changing the table’s appearance, but it
could.</p></li>
</ul><p>Now that we have a <code>DT</code> table (a complex interactive
graphic), there are four things we’ll <em>very</em> commonly want to do
with one (or any similarly complex interactive graphic):</p>
<ol style="list-style-type: decimal"><li><p>Simplify it,</p></li>
<li><p>Restyle it,</p></li>
<li><p>Watch it for <strong>events</strong>, and</p></li>
<li><p>Update it to <strong>handle</strong> those events.</p></li>
</ol><p>Let’s tackle the first two items above first.</p>
</div>
<div class="section level3">
<h3 id="more-or-less-basic-dt">More (or less) basic DT<a class="anchor" aria-label="anchor" href="#more-or-less-basic-dt"></a></h3>
<p>As we just saw, <code>DT</code>s come with many interactive features!
However, “more” is not always “better” from a <strong>UX</strong>
(<strong>user experience</strong>) standpoint. Some users might find
certain features confusing, especially if they aren’t necessary, are
poorly explained, or don’t result in any obvious responses. Others may
find having a lot of features overwhelming, even if they understand them
all.</p>
<p>The <code>datatable()</code> function’s <code>options</code> allows
us to reel in the features our table comes with:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** ALL table-related code contained within your server.R file!</span></span>
<span></span>
<span><span class="co">###BASIC GAPMINDER TABLE</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_table</span> <span class="op">=</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">gap</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">datatable</span><span class="op">(</span></span>
<span>        selection <span class="op">=</span> <span class="st">"none"</span>, <span class="co">#&lt;--TURNS OFF ROW SELECTION</span></span>
<span>        options <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>          info <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#&lt;--NO BOTTOM-LEFT INFO</span></span>
<span>          ordering <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#&lt;--NO SORTING</span></span>
<span>          searching <span class="op">=</span> <span class="cn">FALSE</span> <span class="co">#&lt;--NO SEARCH BAR</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">##TABLE OBSERVER (BUTTON)</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">go_button</span>, <span class="op">{</span> </span>
<span>    </span>
<span>    <span class="va">output</span><span class="op">$</span><span class="va">basic_table</span> <span class="op">=</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="va">gap</span> <span class="op">%&gt;%</span> </span>
<span>        <span class="fu">arrange</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">sorted_column</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>        <span class="co">#SAME AS ABOVE</span></span>
<span>        <span class="fu">datatable</span><span class="op">(</span></span>
<span>          selection <span class="op">=</span> <span class="st">"none"</span>, </span>
<span>          options <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>            info <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>            ordering <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            searching <span class="op">=</span> <span class="cn">FALSE</span> </span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>That’s better! This version might be more digestible and intuitive
for most users (and easier for us to explain and program around!).</p>
<figure><img src="../fig/disabled%20DT.png" alt="Notice that, in this DT, there are no sorting arrows, no search bar, no current page info in the bottom-left, and no row selection." class="figure mx-auto d-block"><div class="figcaption">Notice that, in this DT, there are no sorting
arrows, no search bar, no current page info in the bottom-left, and no
row selection.</div>
</figure><p>More broadly, <em>if a <code>DT</code> table (or any other complex
interactive graphic) has a feature, you should assume you can turn it
off (you may just have to Google for the specific input
needed).</em></p>
<p>Next, let’s tinker with our table’s aesthetics. Let’s make three
(idosyncratic) changes:</p>
<ol style="list-style-type: decimal"><li><p>Round the GDP per capita data.</p></li>
<li><p>Make the <code>continent</code> column center-aligned.</p></li>
<li><p>Highlight in pink all rows with <code>lifeExp</code> values &gt;
<code>70</code>.</p></li>
</ol><p>We’ll use functions from the <code>format*()</code> and
<code>style*()</code> families for this: specifically,
<code>formatRound()</code>, <code>formatStyle()</code>, and
<code>styleEqual()</code>:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** ALL table-related code contained within your server.R file!</span></span>
<span></span>
<span><span class="co">###BASIC GAPMINDER TABLE</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_table</span> <span class="op">=</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">gap</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">datatable</span><span class="op">(</span></span>
<span>        selection <span class="op">=</span> <span class="st">"none"</span>, <span class="co">#&lt;--TURNS OFF ROW SELECTION</span></span>
<span>        options <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>          info <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#&lt;--NO BOTTOM-LEFT INFO</span></span>
<span>          ordering <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#&lt;--NO SORTING</span></span>
<span>          searching <span class="op">=</span> <span class="cn">FALSE</span> <span class="co">#&lt;--NO SEARCH BAR</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="co">#IN THESE FUNCTIONS, WE WRITE 'R-LIKE' CSS CODE. WE USE camelCase FOR PROPERTIES, TEXT STRINGS FOR VALUES, AND = INSTEAD OF : TO SEPARATE THEM.</span></span>
<span>      <span class="fu">formatRound</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"gdpPercap"</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">formatStyle</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"continent"</span>, textAlign <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--COMPARE TO [text-align: center;]</span></span>
<span>      <span class="fu">formatStyle</span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="st">"lifeExp"</span>, <span class="co">#&lt;--wHAT COLUMN WILL WE USE TO CONDITIONALLY FORMAT?</span></span>
<span>        target <span class="op">=</span> <span class="st">"row"</span>, <span class="co">#&lt;--WILL WE STYLE ROWS OR CELLS?</span></span>
<span>        backgroundColor <span class="op">=</span> <span class="fu">styleEqual</span><span class="op">(</span></span>
<span>          levels <span class="op">=</span> <span class="va">gap</span><span class="op">$</span><span class="va">lifeExp</span>, </span>
<span>          values <span class="op">=</span> <span class="fu">ifelse</span><span class="op">(</span><span class="va">gap</span><span class="op">$</span><span class="va">lifeExp</span> <span class="op">&gt;</span> <span class="fl">70</span>, <span class="st">"lightpink"</span>, <span class="st">"white"</span><span class="op">)</span> <span class="co">#WHAT RULE WILL WE USE, AND WHAT NEW CSS VALUES WILL WE SET TO EACH POSSIBILITY?</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">##TABLE OBSERVER (BUTTON)</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">go_button</span>, <span class="op">{</span> </span>
<span>    </span>
<span>    <span class="va">output</span><span class="op">$</span><span class="va">basic_table</span> <span class="op">=</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="va">gap</span> <span class="op">%&gt;%</span> </span>
<span>        <span class="fu">arrange</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">sorted_column</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">datatable</span><span class="op">(</span></span>
<span>          selection <span class="op">=</span> <span class="st">"none"</span>, </span>
<span>          options <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>            info <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>            ordering <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            searching <span class="op">=</span> <span class="cn">FALSE</span> </span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="co">#SAME AS ABOVE</span></span>
<span>        <span class="fu">formatRound</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"gdpPercap"</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">formatStyle</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"continent"</span>, textAlign <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>        <span class="fu">formatStyle</span><span class="op">(</span></span>
<span>          columns <span class="op">=</span> <span class="st">"lifeExp"</span>, </span>
<span>          target <span class="op">=</span> <span class="st">"row"</span>, </span>
<span>          backgroundColor <span class="op">=</span> <span class="fu">styleEqual</span><span class="op">(</span></span>
<span>            levels <span class="op">=</span> <span class="va">gap</span><span class="op">$</span><span class="va">lifeExp</span>, </span>
<span>            values <span class="op">=</span> <span class="fu">ifelse</span><span class="op">(</span><span class="va">gap</span><span class="op">$</span><span class="va">lifeExp</span> <span class="op">&gt;</span> <span class="fl">70</span>, <span class="st">"lightpink"</span>, <span class="st">"white"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/SPIFFY%20dt.png" alt="Now, our continent column values are center-aligned instead of left-aligned, our GDP data are less unruly (because we’ve rounded them), and any row with a life expectancy value &gt; 70 is now light pink, perhaps helping these rows stand out from all others." class="figure mx-auto d-block"><div class="figcaption">Now, our continent column values are
center-aligned instead of left-aligned, our GDP data are less unruly
(because we’ve rounded them), and any row with a life expectancy value
&gt; 70 is now light pink, perhaps helping these rows stand out from all
others.</div>
</figure><p><code>format*()</code> functions ask us to pick 1+ columns to
restyle. Then, we provide <strong>property</strong> and
<strong>value</strong> pairings as inputs, just as we would using CSS
code, but using “R-like” syntax instead, <em>e.g.</em>,
<code>textAlign = center</code> versus
<code>text-align: center;</code>.</p>
<p>If we want to format a column <strong>conditionally</strong>,
<em>i.e.</em>, formatting only <em>some</em> rows according to a rule,
we use the <code>style*()</code> functions. In the example above, we
used <code>styleEqual()</code> to apply a light pink background to only
rows with life expectancy greater than <code>70</code>. This might now
stand out to users in ways that enable certain workflows.</p>
</div>
</section><section><h2 class="section-heading" id="update-dont-remake-dt-edition">Update, don’t remake, DT edition!<a class="anchor" aria-label="anchor" href="#update-dont-remake-dt-edition"></a></h2>
<hr class="half-width"><p>So far, when user actions have dictated change to the data in our
table (<em>e.g.</em>, how it’s sorted), we’ve re-rendered the
<em>entire</em> table to <strong>handle</strong> those
<strong>events</strong>.</p>
<p>This works, but it’s undesirable for (at least) three reasons:</p>
<ol style="list-style-type: decimal"><li><p>With large data sets, it could be <em>slow</em>! Remember that,
as R code executes server-side, the app will become completely
unresponsive, so your users will have to sit around while your code
finishes.</p></li>
<li>
<p>To the user, the table may appear to “flicker” out and in again
as it’s remade (if that’s fast).</p>
<ol style="list-style-type: decimal"><li>If it’s slow, the table will instead “gray out” and the whole app
will “freeze” while the code completes.</li>
</ol></li>
<li><p>If the user had customized the table in any way (they’ve
navigated to a specific page, <em>e.g.</em>), those customizations will
be lost if we rebuild the table.</p></li>
</ol><p>If you think about it, if <em>all</em> we’re doing is changing the
data in our table, there’s no need to remake the <em>whole</em>
table—why blow up and rebuild all the rows, columns, and cells when we
just need to change what’s <em>in</em> the cells? <em>Whenever
possible,</em> <em>we should update a complex interactive graphic
element rather than remake it.</em></p>
<p>To update complex interactive graphic elements”on the fly,” we use
<strong>proxies.</strong> These are like a telephone that lets R (server
side) and JavaScript (client side) talk directly to adjust a widget
without refashioning any aspects that don’t need adjustment.</p>
<p><code>DT</code>’s <code>dataTableProxy()</code> function takes as
input the <code>outputId</code> of the table we’re updating. We then
pipe it into a helper function such as <code>replaceData()</code>, which
specifically swaps out the data inside the table’s cells (adjusting cell
number as needed).</p>
<p>Before that though, we should create a reason we’d <em>need</em> to
swap data sets! Earlier, I mentioned that <code>DT</code> tables have a
<code>selection</code> feature, which allows users to select
rows/columns/cells, an <strong>event</strong> Shiny can watch for.
Although these events are not handled by default, we can change
that!</p>
<p>Let’s create a system in which users can click any cell to select it.
When they do, we’ll filter the table to only rows sharing that same
value in that column (<em>e.g.</em>, clicking a cell containing
<code>Asia</code> will filter to only rows also containing
<code>Asia</code> for <code>continent</code>).</p>
<p>Meanwhile, when no cell is selected (or, equivalently, a selected
cell gets deselected), no filtering is applied.</p>
<p>Sounds complicated? Well, yes and no. There are a number of steps
involved, but none are particularly involved.</p>
<p>So, we’ll go one step at a time. For each, implement the coding
change, run the app, and make sure you understand any changes to the
app’s behaviors.</p>
<p>First, let’s turn on <code>selection</code> inside
<code>datatable()</code> by changing the input from <code>"none"</code>
to <code>list(mode = "single", target = "cell")</code>, which will
enable users to select one cell at a time:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** ALL table-related code contained within your server.R file!</span></span>
<span></span>
<span><span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">###BASIC GAPMINDER TABLE</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_table</span> <span class="op">=</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">gap</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">datatable</span><span class="op">(</span></span>
<span>        selection <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"single"</span>, target <span class="op">=</span> <span class="st">"cell"</span><span class="op">)</span>, <span class="co">#&lt;--TURN ON SINGLE-CELL SELECTION</span></span>
<span>        options <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>          info <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>          ordering <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>          searching <span class="op">=</span> <span class="cn">FALSE</span> </span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">formatRound</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"gdpPercap"</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">formatStyle</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"continent"</span>, textAlign <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">formatStyle</span><span class="op">(</span></span>
<span>        columns <span class="op">=</span> <span class="st">"lifeExp"</span>, </span>
<span>        target <span class="op">=</span> <span class="st">"row"</span>, </span>
<span>        backgroundColor <span class="op">=</span> <span class="fu">styleEqual</span><span class="op">(</span></span>
<span>          levels <span class="op">=</span> <span class="va">gap</span><span class="op">$</span><span class="va">lifeExp</span>, </span>
<span>          values <span class="op">=</span> <span class="fu">ifelse</span><span class="op">(</span><span class="va">gap</span><span class="op">$</span><span class="va">lifeExp</span> <span class="op">&gt;</span> <span class="fl">70</span>, <span class="st">"lightpink"</span>, <span class="st">"white"</span><span class="op">)</span> </span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">##TABLE OBSERVER (BUTTON)</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">go_button</span>, <span class="op">{</span> </span>
<span>    </span>
<span>    <span class="va">output</span><span class="op">$</span><span class="va">basic_table</span> <span class="op">=</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="va">gap</span> <span class="op">%&gt;%</span> </span>
<span>        <span class="fu">arrange</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">sorted_column</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>        <span class="fu">datatable</span><span class="op">(</span></span>
<span>          selection <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"single"</span>, target <span class="op">=</span> <span class="st">"cell"</span><span class="op">)</span>, <span class="co">#&lt;--SAME AS ABOVE</span></span>
<span>          options <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>            info <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>            ordering <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            searching <span class="op">=</span> <span class="cn">FALSE</span> </span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">formatRound</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"gdpPercap"</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">formatStyle</span><span class="op">(</span>columns <span class="op">=</span> <span class="st">"continent"</span>, textAlign <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>        <span class="fu">formatStyle</span><span class="op">(</span></span>
<span>          columns <span class="op">=</span> <span class="st">"lifeExp"</span>, </span>
<span>          target <span class="op">=</span> <span class="st">"row"</span>, </span>
<span>          backgroundColor <span class="op">=</span> <span class="fu">styleEqual</span><span class="op">(</span></span>
<span>            levels <span class="op">=</span> <span class="va">gap</span><span class="op">$</span><span class="va">lifeExp</span>, </span>
<span>            values <span class="op">=</span> <span class="fu">ifelse</span><span class="op">(</span><span class="va">gap</span><span class="op">$</span><span class="va">lifeExp</span> <span class="op">&gt;</span> <span class="fl">70</span>, <span class="st">"lightpink"</span>, <span class="st">"white"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>At this point, our table allows cell selection but doesn’t yet
respond to it. Perhaps more glaringly, though, we’re still re-rendering
the <em>entire</em> table every time the “Go!” button is pressed even
though the “bones” of the table aren’t changing. This requires us to
duplicate a <em>lot</em> of code (pretty much all contents of our
<code>renderDT({})</code>s—that’s a sign we’re being inefficient!</p>
<p>Let’s fix that by adjusting our <code>observeEvent({},{})</code> so
that it uses <code>dataTableProxy()</code> and
<code>replaceData()</code> to update, rather than remake, the table:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the TABLE OBSERVER subsection of your server.R file!</span></span>
<span></span>
<span><span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">##TABLE OBSERVER (BUTTON)</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">go_button</span>, <span class="op">{</span> </span>
<span>    </span>
<span>    <span class="co">#SORT THE DATA AS USUAL...</span></span>
<span>   <span class="va">gap_sorted</span> <span class="op">=</span> <span class="va">gap</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">arrange</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">sorted_column</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">#FEED THE SORTED DATA INTO A PROXY...</span></span>
<span>    <span class="fu">dataTableProxy</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="co">#THEN, SIMPLY SWAP OUT THE OLD DATA FOR THE NEW (NO RE-RENDERING!). ALSO, KEEP CELL SELECTION AS IT WAS.</span></span>
<span>      <span class="fu">replaceData</span><span class="op">(</span>data <span class="op">=</span> <span class="va">gap_sorted</span>, <span class="co">#&lt;--NOTE CHANGE IN DF REFERENCED HERE.</span></span>
<span>                  clearSelection <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="co">##IF YOU MAKE THIS CHANGE, THE APP SHOULD WORK AS IT HAS, EXCEPT THE CHANGES TO THE TABLE WHEN HITTING THE GO BUTTON SHOULD BE SUBTLER AND SMOOTHER THAN BEFORE.</span></span></code></pre>
</div>
<p>This observer is now much cleaner than before. All adjustments to the
table’s features and aesthetics happen up front and then never again in
the original <code>renderDT({})</code> call, whereas the sorting (and
<em>only</em> the sorting) happens in the observer. We also don’t
re-render the table; instead, we use a proxy to swap in new data.</p>
<p>…Of course, we still need to also watch for changes in cell
selection. But how?</p>
<p>Like others widget, <em><code>DT</code>s pass information from the UI
to the server using the <code>input</code> object</em>,and we can access
that information server-side using <code>input$outputId_*</code>
format.</p>
<p>In this case, the <code>*</code> will be <code>cells_selected</code>
because that’s the <strong>event type</strong> of interest:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **added to** your server.R file, below all previous code but within your server function!</span></span>
<span></span>
<span><span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">##TABLE OBSERVER (CELL SELECTION)</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span>, <span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">print</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">)</span> <span class="co">#&lt;--PRINT TO THE R CONSOLE THE CONTENTS OF THIS OBJECT EVERY TIME THIS EXPRESSION EXECUTES.</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Here, we learn a little trick: R’s <code>print()</code> function can
be used to show the current value of a <strong>reactive object</strong>
at specific time points. This is useful for seeing what reactive objects
look like, as in this case. It can also be useful for debugging
(<em>e.g.</em>, to see when an observer detects (or fails to detect) an
event).</p>
<p>If you run the app now and start selecting cells, you’ll observe that
<code>input$basic_table_cells_selected</code> returns a matrix when
accessed. Either this matrix has no rows (when no cell is selected, such
as on start-up) or one row with two values: row and column numbers for
the selected cell.</p>
<figure><img src="../fig/cell%20selection.gif" alt="By using print(), we can see when our observer executes its second expression and also what our cell selection reactive object looks like when that happens." class="figure mx-auto d-block"><div class="figcaption">By using print(), we can see when our observer
executes its second expression and also what our cell selection reactive
object looks like when that happens.</div>
</figure><p>We can use that info being tracked to find the value in the selected
cell plus the name of the column of the selected cell. We can then
filter our data set accordingly (this just requires some good,
old-fashioned “R” data wrangling! If the R code here is too much for
you, just copy-paste it and don’t worry too much about what exactly it
does):</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the TABLE OBSERVER subsection of your server.R file!</span></span>
<span></span>
<span><span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">##TABLE OBSERVER (CELL SELECTION)</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span>, <span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu">req</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">)</span> <span class="co">#&lt;--THE req() FUNCTION WORKS A BIT LIKE IF--IF THE CONTENTS DON'T EXIST, NOTHING ELSE BELOW req() WILL RUN.</span></span>
<span>    </span>
<span>    <span class="co">#WHAT WAS THE VALUE IN THE SELECTED CELL?</span></span>
<span>    <span class="va">val2match</span> <span class="op">=</span> <span class="va">gap</span><span class="op">[</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                    <span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                    drop <span class="op">=</span> <span class="cn">T</span><span class="op">]</span> <span class="co">#&lt;--PRODUCE A VECTOR, NOT A DATA FRAME</span></span>
<span>    </span>
<span>    <span class="co">#WHAT WAS THE NAME OF THE COLUMN OF THE SELECTED CELL?</span></span>
<span>    <span class="va">col2match</span> <span class="op">=</span> <span class="fu">names</span><span class="op">(</span><span class="va">gap</span><span class="op">)</span><span class="op">[</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co">#FILTER THE DATA SET BY THAT COLUMN TO ONLY CELLS WITH THAT SAME VALUE.</span></span>
<span>    <span class="va">gap_filtered</span> <span class="op">=</span> <span class="va">gap</span><span class="op">[</span><span class="va">gap</span><span class="op">[</span>, <span class="va">col2match</span><span class="op">]</span> <span class="op">==</span> <span class="va">val2match</span>, <span class="op">]</span></span>
<span>    </span>
<span>    <span class="fu">dataTableProxy</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">replaceData</span><span class="op">(</span>data <span class="op">=</span> <span class="va">gap_filtered</span>, <span class="co">#&lt;--REFERENCE gap_filtered HERE. </span></span>
<span>                  clearSelection <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Here, we meet another handy tool: <code>req()</code>.
<code>req()</code> checks to make sure its contents exist
(<em>i.e.</em>, aren’t <code>NULL</code>, <code>NA</code>, blank, etc.).
If they don’t, all remaining code beneath <code>req()</code> won’t
run.</p>
<p>We need it here because <code>input$basic_table_cells_selected</code>
won’t exist sometimes (like on start-up and when no cells are selected).
In those instances, the rest of our code in this observer would
break.</p>
<p>Our observer works! …Or does it? Try it and see:</p>
<figure><img src="../fig/bad%20filtering.gif" alt="The filtering doesn’t work the way it ought to–when we click on an ‘Asia’ cell, we get back ‘Africa’ results. What gives?" class="figure mx-auto d-block"><div class="figcaption">The filtering doesn’t work the way it ought
to–when we click on an ‘Asia’ cell, we get back ‘Africa’ results. What
gives?</div>
</figure><p>On the first click, we get the behavior we expect—if we click a cell
containing <code>Asia</code>, we get back <em>only</em> other results
from <code>Asia</code>. However, depending upon where we click next, we
might get back the wrong results. Can you guess why?</p>
<p>The issue is this command:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">val2match</span> <span class="op">=</span> <span class="va">gap</span><span class="op">[</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                <span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, </span>
<span>                drop <span class="op">=</span> <span class="cn">T</span><span class="op">]</span></span></code></pre>
</div>
<p>We use the row and column numbers in
<code>input$basic_table_cells_selected</code> to find the value inside
the cell selected by finding that same cell in <code>gap</code>.</p>
<p>This works great…the <em>first</em> time. However, the
<em>second</em> time, <code>input$basic_table_cells_selected</code>
contains row and column numbers based on a <em>filtered</em> version of
<code>gap</code>, but we still try to use those row and column numbers
to pull a value out of the <em>original</em> version of
<code>gap</code>. They probably won’t line up!</p>
<p>It seems we need to track the data set so that we’re always
referencing the one users can actually see, especially if they’ve
already filtered one or more times.</p>
<p>This looks like a job for a <strong>reactive value</strong>! Like
<code>input</code> and <code>output</code>, a reactive value is a
“changeable object” that R knows to watch for events. Unlike
<code>input</code> and <code>output</code>, though, we create reactive
values ourselves and can code exactly when and how they change. We
create a reactive value using <code>reactiveVal()</code>, placing the
starting value inside the parentheses:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **added to** your server.R file anywhere inside your server function but outside any reactive contexts!</span></span>
<span></span>
<span><span class="co">##... other server code...</span></span>
<span></span>
<span><span class="va">current_data</span> <span class="op">=</span> <span class="fu">reactiveVal</span><span class="op">(</span><span class="va">gap</span><span class="op">)</span> <span class="co">#&lt;--WHEN THE APP STARTS, WE STORE gap AS THE STARTING DATA SET.</span></span></code></pre>
</div>
<p>From then on, if we want to access the reactive value’s current
value, we use its name like a function, <em>e.g.</em>,
<code>current_data()</code>. If we want to <em>change</em> the reactive
value’s current value, we can put the new value inside the parentheses,
<em>e.g.</em>, <code>current_data(new)</code>.</p>
<p>Let’s enhance both our observers so that they reference</p>
<p>…Except there’s no “undo.” Once we select a cell, we filter out all
rows that don’t match, and those rows are “lost” to the user because
there’s no way to restore them. And further clicks only cause loss of
more rows!</p>
<p>This is because we didn’t <strong>handle</strong> the <em>other</em>
possibility: that the user has not selected any cell (or that they’ve
de-selected the cell they just had selected, which is functionally the
same).</p>
<p>Whenever no cell is selected, we need to “return” to the original
<code>gapminder</code> data set, albeit sorted appropriately. We can
handle this scenario using <code>if()/else</code>:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the observeEvent({},{}) we introduced in the previous example!</span></span>
<span></span>
<span><span class="co">##... other server code...</span></span>
<span></span>
<span>  <span class="co">###TABLE OBSERVER (CELL SELECTION)</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="fu">list</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">go_button</span>, <span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">)</span>, <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co">##STEP 6: WE ADD IN AN IF/ELSE PAIR. WE RESPOND ACCORDINGLY WHETHER THERE IS A CELL SELECTED OR NOT.</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu">nrow</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="va">val2match</span> <span class="op">=</span> <span class="va">gap</span><span class="op">[</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, drop <span class="op">=</span> <span class="cn">T</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="va">col2match</span> <span class="op">=</span> <span class="fu">names</span><span class="op">(</span><span class="va">gap</span><span class="op">)</span><span class="op">[</span><span class="va">input</span><span class="op">$</span><span class="va">basic_table_cells_selected</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="va">gap_filtered</span> <span class="op">=</span> <span class="va">gap</span><span class="op">[</span><span class="va">gap</span><span class="op">[</span>, <span class="va">col2match</span><span class="op">]</span> <span class="op">==</span> <span class="va">val2match</span>, <span class="op">]</span></span>
<span>      </span>
<span>      <span class="va">gap_sorted</span> <span class="op">=</span> <span class="va">gap_filtered</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">arrange</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">sorted_column</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="fu">dataTableProxy</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">replaceData</span><span class="op">(</span>data <span class="op">=</span> <span class="va">gap_sorted</span>, clearSelection <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co">#OTHERWISE, WE SIMPLY SORT THE ORIGINAL GAPMINDER DATA SET AS WE HAVE PREVIOUSLY. </span></span>
<span>      <span class="va">gap_sorted</span> <span class="op">=</span> <span class="va">gap</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">arrange</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">sorted_column</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="fu">dataTableProxy</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">replaceData</span><span class="op">(</span>data <span class="op">=</span> <span class="va">gap_sorted</span>, clearSelection <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Now, we can filter and unfilter our table with just a click! This
functionality could empower a variety of dynamic, engaging workflows for
your users.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Using if/else to handle “undoing” previous actions works really well,
but some users could find it unintuitive. They might not even realize
it’s something they can do!</p>
<p>A more conventional, “expected” approach might be a “reset” button
that restores the original table when pressed.</p>
<p>See if you can figure out how to build such a button <em>without</em>
losing <em>any</em> of the app’s current functionality.</p>
<p>If you succeed, consider whether you, as a user, would prefer the
“select nothing to undo” functionality or the “reset button”
functionality, or if you’d prefer having both.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>First, we add the reset button to our UI, just below the current
“Go!” button:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode r" tabindex="0"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="do">##This code should **be added to** the "sidebar" content of the Table tabPanel in the BODY section of your ui.R file!</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="do">##... other UI code...</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="fu">actionButton</span>(<span class="at">inputId =</span> <span class="st">"go_button"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>                        <span class="at">label =</span> <span class="st">"Go!"</span>)<span class="er">)</span>,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="fu">actionButton</span>(<span class="at">inputId =</span> <span class="st">"reset_button"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>                        <span class="at">label =</span> <span class="st">"Reset!"</span>)<span class="er">)</span>,</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  <span class="do">##... other UI code...</span></span></code></pre>
</div>
<p>Then, in our server file, we add a new observer to watch that button
and handle when a user presses it. This is pretty simple here: we use
our proxy to restore the original <code>gapminder</code> data set:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **added to** your server.R file, underneath all other contents inside of your server function!</span></span>
<span></span>
<span><span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">reset_button</span>, <span class="op">{</span></span>
<span>              </span>
<span>  <span class="co">##WE REWIND ALL THE WAY BACK TO THE ORIGINAL GAPMINDER DATA AND CLEAR ANY SELECTIONS THE USER MAY ALREADY HAVE MADE.</span></span>
<span>    <span class="fu">dataTableProxy</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">replaceData</span><span class="op">(</span>data <span class="op">=</span> <span class="va">gap</span>, </span>
<span>                clearSelection <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span>     </span>
<span> <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>As for what I prefer, I think I’d rather have both functionalities.
Together, they make our app more accessible because, while the “click to
undo” approach is easy and precise as an undo mechanism, not every user
may discover or understand it (unless they’re trained well!).</p>
<p>A reset button, meanwhile, is something nearly everyone understands
intuitively. The way we’ve coded it here is pretty “aggressive” in that
it undoes <em>everything</em>, but that will at least match with the
expectations of most users.</p>
<p>And, on the plus side, the reset button enables undoing any sorting,
functionality that didn’t previously exist in any previous version we’ve
had!</p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="putting-us-on-the-map">Putting us on the map<a class="anchor" aria-label="anchor" href="#putting-us-on-the-map"></a></h3>
<div class="section level4">
<h4 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a></h4>
<p>Before we go any further, we need to “massage” our data set to make
it ready for mapping (spatial data are complicated!). Add the following
to your <code>global.R</code> file at the end <em>verbatim</em>. Don’t
worry about what it does, though!</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###MASSAGE DATA SET FOR MAKING MAPS</span></span>
<span><span class="va">gap</span><span class="op">$</span><span class="va">country</span> <span class="op">=</span> <span class="fu">as.character</span><span class="op">(</span><span class="va">gap</span><span class="op">$</span><span class="va">country</span><span class="op">)</span></span>
<span><span class="va">gap</span><span class="op">$</span><span class="va">continent</span> <span class="op">=</span> <span class="fu">as.character</span><span class="op">(</span><span class="va">gap</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gap</span><span class="op">$</span><span class="va">ID</span> <span class="op">=</span> <span class="fu">countrycode</span><span class="op">(</span><span class="va">gap</span><span class="op">$</span><span class="va">country</span>, <span class="st">"country.name"</span>, <span class="st">"iso3c"</span><span class="op">)</span></span>
<span><span class="va">world</span> <span class="op">=</span> <span class="fu">read_sf</span><span class="op">(</span><span class="st">"TM_WORLD_BORDERS_SIMPL-0.3.shp"</span><span class="op">)</span> <span class="co">#&lt;--THIS FILE CAN BE DOWNLOADED VIA &lt;https://drive.google.com/file/d/1Ta0GSnoJPyEMFjjbpzE3Z8RD0Mq18RL7/view?usp=sharing&gt;. MAKE SURE TO UNZIP IT AND MOVE IT AND ALL ITS COMPANION FILES INTO YOUR R PROJECT FOLDER!</span></span>
<span></span>
<span><span class="va">world2</span> <span class="op">=</span> <span class="va">world</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">ISO3</span>, <span class="va">geometry</span><span class="op">)</span></span>
<span><span class="va">gap_map</span> <span class="op">=</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">gap</span>, <span class="va">world2</span>, by <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"ID"</span> <span class="op">=</span> <span class="st">"ISO3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gap_map</span> <span class="op">=</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">gap_map</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level4">
<h4 id="preface">Preface<a class="anchor" aria-label="anchor" href="#preface"></a></h4>
<p><code>DT</code> has shown us how more complex widgets operate in R
Shiny, so we can switch to making map widgets using
<code>leaflet</code>. We’ll follow the same roadmap we just used for
<code>DT</code>:</p>
<ol style="list-style-type: decimal"><li><p>We’ll start with a basic map.</p></li>
<li><p>Then, we’ll adjust some features and dress up its
aesthetics.</p></li>
<li><p>Lastly, we’ll learn about map-specific events and how to handle
those events <em>without</em> redrawing the entire map.</p></li>
</ol><p>The specifics will be different, but all the concepts here we’ve
already been introduced to, so we can get another round of practice with
them.</p>
</div>
<div class="section level4">
<h4 id="basic-map">Basic map<a class="anchor" aria-label="anchor" href="#basic-map"></a></h4>
<p>Let’s make a <code>leaflet</code> map showing the countries in our
data set colored by their 2007 life expectancy data. We’ll place the
result in our UI’s “Map” tab panel.</p>
<p>Every <code>leaflet</code> map has three building blocks:</p>
<ol style="list-style-type: decimal"><li><p>A <code>leaflet()</code> call. This function is like
<code>ggplot()</code> from the <code>ggplot2</code> package—it “sets the
stage” for the rest of the graphic, and you can specify some settings
here that’ll apply to all subsequent components.</p></li>
<li><p>A <code>addTiles()</code> call. This function place’s a “tile,”
or background, on your map. This is that thing indicating where lakes
and roads and boundaries are! We’ll use the default tile here, but there
are many others to choose from.</p></li>
<li>
<p>At least one <code>add*()</code> function call for adding
<strong>spatial data</strong> to our map. There are others, but the
three most commonly used ones are:</p>
<ol style="list-style-type: decimal"><li><p><code>addMarkers()</code> adds <strong>spatial point</strong>
(0-dimensional) <strong>data</strong> (like the locations of
restaurants).</p></li>
<li><p><code>addLines()</code> adds <strong>spatial line/curve</strong>
(1-dimensional) <strong>data</strong> (like roads or rivers).</p></li>
<li><p><code>addPolygons()</code> adds <strong>spatial polygon</strong>
(2-dimensional) <strong>data</strong> (like country
boundaries).</p></li>
</ol></li>
</ol><p>Here, we’ll use <code>addPolygons()</code>:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **swapped** for the the "main panel" content in the BODY section of your ui.R file!</span></span>
<span></span>
<span><span class="co">##... other UI code...</span></span>
<span></span>
<span><span class="co">###MAIN PANEL CELL</span></span>
<span>    <span class="fu">column</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">8</span>, <span class="fu">tabsetPanel</span><span class="op">(</span></span>
<span>      <span class="co">###TABLE TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Table"</span>, <span class="fu">dataTableOutput</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="co">###MAP TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Map"</span>, <span class="fu">leafletOutput</span><span class="op">(</span><span class="st">"basic_map"</span><span class="op">)</span><span class="op">)</span>, <span class="co">#&lt;--ADD OUR NEW MAP.</span></span>
<span>      <span class="co">###GRAPH TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Graph"</span>,</span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">##... other UI code...</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **added to** your server.R file, underneath all other contents inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span></span>
<span>    <span class="co">##FILTER TO ONLY 2007 DATA.</span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--GETS THINGS STARTED</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--ADDS A BACKGROUND </span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>, <span class="co">#SPECIFY OUR SPATIAL DATA (geometry IS AN sf PACKAGE CONSTRUCTION)</span></span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>, <span class="co">#&lt;-BLACK OUTLINE</span></span>
<span>        weight <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co">#THICKER-THAN-DEFAULT OUTLINE.</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>The code above creates a nice, if somewhat basic, interactive map
showing the countries for which we have data, outlined in black. Notice
that you can <strong>pan</strong> the map by clicking anywhere, holding
the click, and moving the mouse.</p>
<p>Notice that you can also <strong>zoom</strong> the map in or out
using your mouse wheel (if you have one), or by using the plus/minus
buttons in the top-left corner. Double-clicking on the map also zooms
in.</p>
<p>If you zoom in a lot, you’ll see the tile change to show greater
detail. If you zoom out, you’ll see the world actually repeat several
times left-to-right, if your screen is wide enough…pretty weird!</p>
</div>
<div class="section level4">
<h4 id="more-or-less-basic-map">More (or less) basic map<a class="anchor" aria-label="anchor" href="#more-or-less-basic-map"></a></h4>
<p>As we just saw, it often doesn’t make sense to allow users to
<strong>pan</strong> and <strong>zoom</strong> without any
guardrails—they can get lost or produce unhelpful visual quirks to
arise. As I noted earlier, <code>leaflet()</code> contains many global
settings we can apply to our map. For example, we can set min and max
zoom levels like so:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">##THE leaflet() FUNCTION HAS A LIST OF OPTIONS WE CAN ADJUST, SUCH AS THE MIN AND MAX ZOOM LEVELS.</span></span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>        weight <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>A <code>minZoom</code> of 2 is one in which <em>almost</em> the
entire world is visible at once (on my laptop, anyway!). A
<code>maxZoom</code> of 6 allows users to zoom into specific continental
regions but no further. This keeps users from zooming in or out to a
degree that doesn’t really make sense given our data.</p>
<p>We can also set <strong>maximum bounds</strong>—users can’t
<strong>pan</strong> the map past these:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">#THE SF PACKAGE'S st_bbox() FUNCTION GETS THE FOUR POINTS THAT WOULD CREATE A BOX FULLY BOUNDING ALL SPATIAL DATA WE GIVE IT AS INPUTS.</span></span>
<span>    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">unname</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>        weight <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>  </span>
<span>      <span class="co">##setMaxBounds() TAKES, AS INPUTS, THOSE EXACT SAME FOUR POINTS.</span></span>
<span>      <span class="fu">setMaxBounds</span><span class="op">(</span><span class="va">bounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>When a user tries to pan past the bounds, the map will “snap back” to
a focus point within the bounds.</p>
<p>While there are other features we could adjust or disable, setting
bounds and a minimum and maximum zoom are two things you’ll generally
want to do to every map you make.</p>
<div class="section level5">
<h5 id="adding-some-pizzazz">Adding some pizzazz<a class="anchor" aria-label="anchor" href="#adding-some-pizzazz"></a></h5>
<p>Our map is still rather basic-looking. In fact, it doesn’t even
fulfill the minimum specifications we’d set—it doesn’t show the life
expectancy data yet.</p>
<p>To fix that, we need to set up a <strong>color palette</strong> so
<code>leaflet</code> knows <em>how</em> to fill our country polygons
(it’s a <em>little</em> fussy!). We can build a color palette using
<code>leaflet</code>’s <code>colorNumeric()</code> function.</p>
<p>This function has two required inputs: a <code>palette</code>, the
name of the R color palette we’d like to use, and a <code>domain</code>,
the set of values we’ll need colors for in our final palette:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">unname</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">#ESTABLISH A COLOR SCHEME TO USE FOR OUR FILLS.</span></span>
<span>    <span class="va">map_palette</span> <span class="op">=</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, domain <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>        weight <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>  </span>
<span>      <span class="fu">setMaxBounds</span><span class="op">(</span><span class="va">bounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Once <code>leaflet</code> knows every value it’ll need a color for
(<code>domain</code>) and every color it should use
(<code>palette</code>), we can add coloring instructions to
<code>addPolygons()</code>:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">unname</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">map_palette</span> <span class="op">=</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, domain <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>, <span class="co">#&lt;--NOTICE THAT THE OUTLINE ("STROKE") HAS A DIFFERENT COLOR PARAMETER THAN THE FILL.</span></span>
<span>        weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        fillColor <span class="op">=</span> <span class="fu">map_palette</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span>, <span class="co">#&lt;--WE USE OUR NEW COLOR PALETTE LIKE A FUNCTION, SPECIFYING OUR DATA AS INPUTS.</span></span>
<span>        fillOpacity <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">#&lt;--THE DEFAULT, 0.5, WASHES OUT THE COLORS TOO MUCH.</span></span>
<span>      <span class="fu">setMaxBounds</span><span class="op">(</span><span class="va">bounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>This is already a <em>much</em> cooler map!</p>
<p>But shouldn’t there be a <strong>legend</strong> that clarifies what
colors go with what values? We can add one using
<code>addLegend()</code>:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">unname</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>   <span class="va">map_palette</span> <span class="op">=</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, domain <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>        weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        fillColor <span class="op">=</span> <span class="fu">map_palette</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>        fillOpacity <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">setMaxBounds</span><span class="op">(</span><span class="va">bounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="co">#ADD A LEGEND TO THE MAP</span></span>
<span>      <span class="fu">addLegend</span><span class="op">(</span></span>
<span>        position <span class="op">=</span> <span class="st">"bottomleft"</span>, <span class="co">#&lt;--WHERE TO PUT IT.</span></span>
<span>        pal <span class="op">=</span> <span class="va">map_palette</span>, <span class="co">#&lt;--COLOR SCHEME TO USE.</span></span>
<span>        values <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span>, <span class="co">#WHAT SCALE ANCHORS ("BREAKS") TO USE.</span></span>
<span>        opacity <span class="op">=</span> <span class="fl">0.75</span>, <span class="co">#LEGEND TRANSPARENCY.</span></span>
<span>        bins <span class="op">=</span> <span class="fl">5</span>, <span class="co">#NUMBER OF BREAKS TO HAVE.</span></span>
<span>        title <span class="op">=</span> <span class="st">"Life&lt;br&gt;expectancy ('07)"</span> <span class="co">#LEGEND TITLE.</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>This is a nice looking map!</p>
<p>…But what if our users don’t know much geography, so they don’t know
which countries are which? Or what if they wanted to know the
<em>exact</em> life expectancy value for a country? This map couldn’t
easily address either issue.</p>
<p>Adding <strong>tooltips</strong> would help address both. A tooltip
is a small pop-up that might appear on mouse hover (in
<code>leaflet</code>, those are called “labels”), on mouse click
(leaflet calls these “popups”), or after some other action.</p>
<p>Using the <code>popup</code> parameter inside
<code>addPolygons()</code>, we can add tooltips that appear and
disappear on mouse click. Inside these, we’ll put the name of the
country being clicked on, in case users don’t know their countries
well:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">unname</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">map_palette</span> <span class="op">=</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, domain <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>        weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        fillColor <span class="op">=</span> <span class="fu">map_palette</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>        fillOpacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        popup <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--MAKE A TOOLTIP HOLDING THE RELEVANT COUNTRY APPEAR/DISAPPEAR ON MOUSE CLICK. </span></span>
<span>      <span class="fu">setMaxBounds</span><span class="op">(</span><span class="va">bounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addLegend</span><span class="op">(</span></span>
<span>        position <span class="op">=</span> <span class="st">"bottomleft"</span>,</span>
<span>        pal <span class="op">=</span> <span class="va">map_palette</span>,</span>
<span>        values <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span>,</span>
<span>        opacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        bins <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Life&lt;br&gt;expectancy ('07)"</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>This is a nice addition, but what if we wanted to add life expectancy
values too? And keep the result human-readable? There are many
approaches we could take, but one using “Normal R’s” versatile
<code>paste0()</code> function plus the HTML line break element
(<code>&lt;br&gt;</code>) is straightforward:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">unname</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">map_palette</span> <span class="op">=</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, domain <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>        weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        fillColor <span class="op">=</span> <span class="fu">map_palette</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>        fillOpacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        popup <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"County: "</span>, <span class="co">#&lt;--WE USE R'S paste0() FUNCTION AND THE HTML LINE BREAK ELEMENT &lt;br&gt; TO MAKE THE TOOLTIP TEXT VERY READABLE AND INFO-RICH.</span></span>
<span>                       <span class="va">gap_map2007</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                       <span class="st">"&lt;br&gt;Life Expectancy: "</span>,</span>
<span>                       <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">setMaxBounds</span><span class="op">(</span><span class="va">bounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addLegend</span><span class="op">(</span></span>
<span>        position <span class="op">=</span> <span class="st">"bottomleft"</span>,</span>
<span>        pal <span class="op">=</span> <span class="va">map_palette</span>,</span>
<span>        values <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span>,</span>
<span>        opacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        bins <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Life&lt;br&gt;expectancy ('07)"</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Now, our map is both snazzy and informative!</p>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>In the previous example, we used <code>popup</code> to build our
tooltips. Try using the <code>label</code> parameter instead. For
whatever reason, this requires more “normal R” data wrangling, so here’s
the <em>exact</em> code you’ll need (feel free to copy and paste
it!):</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">label</span> <span class="op">=</span> <span class="fu">lapply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu">nrow</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> </span>
<span>                    <span class="fu">HTML</span><span class="op">(</span><span class="fu">paste0</span><span class="op">(</span><span class="st">"County: "</span>,</span>
<span>                                 <span class="va">gap_map2007</span><span class="op">$</span><span class="va">country</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>, </span>
<span>                                 <span class="st">"&lt;br&gt;Life Expectancy: "</span>, </span>
<span>                                <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>What changes? Which do you prefer? Which would be better if a lot of
your users will use mobile devices, do you think?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>If we use <code>label</code>, we get tooltips that appears on mouse
hover instead of on mouse click. Actually, this is <em>probably</em>
more intuitive for most users; many will not expect a click to do
anything and may only discover our on-click-style tooltips by
accident!</p>
<p>On the other hand, tooltips that appear on hover can be annoying if a
user is trying to, <em>e.g.</em>, trace a path with their mouse and
irrelevant tooltips keep getting in the way or providing
distractions.</p>
<p>Also, an advantage of on-click tooltips is that they <em>don’t</em>
disappear until a user is ready for them to do so, whereas tooltips that
disappear when the mouse is moved can prevent users from consulting a
tooltip while also using their mouse somewhere else on the page.</p>
<p>However, the biggest potential disadvantage of “on-hover” tooltips is
that, while there is an equivalent to a mouse click on touchscreen
devices (a finger press), there is no <em>universal</em> equivalent to a
mouse hover (some browsers and platforms use a “long press” for this,
but not all, and many users are not accustomed to taking that action
anyway!).</p>
<p>So, mobile users won’t generally see tooltips if they appear
<em>only</em> on hover. If we’re aiming for “mobile-first” design, the
<code>popup</code> option is better (which is why I picked it)!</p>
<p>However, note that by using <code>labelOptions</code>, we can adjust
which events cause tooltips to appear, <em>e.g.</em>, we can make them
appear on both hover and on touch.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="update-dont-remake-leaflet-edition">Update, don’t remake, <code>leaflet</code> edition!<a class="anchor" aria-label="anchor" href="#update-dont-remake-leaflet-edition"></a></h3>
<p>At this stage, our users have <em>no</em> control over <em>which</em>
data are shown in our map. Let’s give them that control by adding a
<strong>slider input widget</strong> that will let them select which
year’s data is plotted:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode r" tabindex="0"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="do">##This code should **replace** the "sidebar panel" cell's content within the BODY section of your ui.R file!</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="do">##... other UI code...</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="do">###SIDEBAR CELL</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>    <span class="fu">column</span>(</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>      <span class="at">width =</span> <span class="dv">4</span>,</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>      <span class="fu">selectInput</span>(</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"sorted_column"</span>,</span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Select a column to sort the table by."</span>,</span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>        <span class="at">choices =</span> <span class="fu">c</span>(</span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>          <span class="st">"Country"</span> <span class="ot">=</span> <span class="st">"country"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>          <span class="st">"Continent"</span> <span class="ot">=</span> <span class="st">"continent"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>          <span class="st">"Year"</span> <span class="ot">=</span> <span class="st">"year"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a>          <span class="st">"Life expectancy"</span> <span class="ot">=</span> <span class="st">"lifeExp"</span>,</span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>          <span class="st">"Population size"</span> <span class="ot">=</span> <span class="st">"pop"</span>,</span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>          <span class="st">"GDP per capita"</span> <span class="ot">=</span> <span class="st">"gdpPercap"</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>        )</span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>      ),</span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>      <span class="fu">actionButton</span>(<span class="at">inputId =</span> <span class="st">"go_button"</span>, <span class="at">label =</span> <span class="st">"Go!"</span>),</span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>      <span class="co"># actionButton(inputId = "reset_button",</span></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a>      <span class="co">#                   label = "Reset!"),</span></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>      <span class="co">#ADD OUR NEWEST SLIDER WIDGET</span></span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a>      <span class="fu">sliderInput</span>(</span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"year_slider"</span>,</span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Pick what year's data are shown in the map."</span>,</span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a>        <span class="at">value =</span> <span class="dv">2007</span>, <span class="co">#&lt;--SET THE DEFAULT CHOICE</span></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a>        <span class="at">min =</span> <span class="fu">min</span>(gap<span class="sc">$</span>year), <span class="co">#&lt;--MIN AND MAX POSSIBLE SELECTIONS</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>        <span class="at">max =</span> <span class="fu">max</span>(gap<span class="sc">$</span>year),</span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a>        <span class="at">step =</span> <span class="dv">5</span>, <span class="co">#&lt;--HOW FAR APART CAN CHOICES BE?</span></span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">""</span> <span class="co">#&lt;--DON'T USE COMMAS TO SEPARATE THE THOUSANDS PLACE.</span></span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a>      )),</span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a>  <span class="do">##... other UI code...</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span><span class="co">###MAP</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co">##WE'LL KEEP THIS DATASET NAMED AFTER YEAR 2007. WE'LL SEE WHY A BIT LATER.</span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fu">as.numeric</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">year_slider</span><span class="op">)</span><span class="op">)</span> <span class="co">#&lt;--INTRODUCE THE  SLIDER'S CURRENT VALUE. EVERY CHANGE TO THIS WILL TRIGGER'S OUR renderLeaflet({}) CODE TO RERUN.</span></span>
<span>    </span>
<span>    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">unname</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">map_palette</span> <span class="op">=</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, domain <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>        weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        fillColor <span class="op">=</span> <span class="fu">map_palette</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>        fillOpacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        popup <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"County: "</span>,</span>
<span>                       <span class="va">gap_map2007</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                       <span class="st">"&lt;br&gt;Life Expectancy: "</span>,</span>
<span>                       <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span></span>
<span>        <span class="co"># label = lapply(1:nrow(gap_map2007), function(x) {</span></span>
<span>        <span class="co">#   HTML(</span></span>
<span>        <span class="co">#     paste0(</span></span>
<span>        <span class="co">#       "County: ",</span></span>
<span>        <span class="co">#       gap_map2007$country[x],</span></span>
<span>        <span class="co">#       "&lt;br&gt;Life Expectancy: ",</span></span>
<span>        <span class="co">#       gap_map2007$lifeExp[x]</span></span>
<span>        <span class="co">#     )</span></span>
<span>        <span class="co">#   )</span></span>
<span>        <span class="co"># })</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">setMaxBounds</span><span class="op">(</span><span class="va">bounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addLegend</span><span class="op">(</span></span>
<span>        position <span class="op">=</span> <span class="st">"bottomleft"</span>,</span>
<span>        pal <span class="op">=</span> <span class="va">map_palette</span>,</span>
<span>        values <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span>,</span>
<span>        opacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        bins <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        title <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"Life&lt;br&gt;expectancy ("</span>, <span class="va">gap_map2007</span><span class="op">$</span><span class="va">year</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">")"</span><span class="op">)</span> <span class="co">#&lt;-HERE, WE GET FANCY USING R's paste0() FUNCTION TO MAKE SURE THE "RIGHT" YEAR IS ALWAYS THE ONE IN THE LEGEND TITLE.</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>This new functionality gives users a new and exciting way to explore
the data!</p>
<p>…However, the way we handle events involving this new input is
<em>not</em> ideal. Each time a user adjusts the slider, the map is
<em>entirely</em> rebuilt. With maps, this can be <em>especially</em>
problematic because spatial data can be <em>very</em> voluminous, so
re-rendering a map from scratch can cause long loading times.</p>
<p>Just as with <code>DT</code>, <code>leaflet</code> features a
<strong>proxy system</strong> that will let us update a map, only
changing features that <em>need</em> to change.</p>
<p>Let’s switch to using that proxy system. The approach will be the
same as with <code>DT</code>:</p>
<ol style="list-style-type: decimal"><li><p>We use <code>renderLeaflet({})</code> to produce <em>just</em>
the “starting” version of the map that the user sees upon
startup.</p></li>
<li><p>We use a new <code>observeEvent({},{})</code> to watch for
relevant events.</p></li>
<li><p>Inside the observer, we use a proxy built using
<code>leafletProxy()</code>, which is analogous to
<code>dataTableProxy()</code>, to update our map:</p></li>
</ol><div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **swapped for** the renderLeaflet({}) code provided previously, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">###MAP</span></span>
<span><span class="co">#renderLeaflet({}) ONLY BUILDS THE FIRST VERSION OF THE MAP. NO REACTIVE OBJECTS HERE, SO IT'LL NEVER RERUN.</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_map</span> <span class="op">=</span> <span class="fu">renderLeaflet</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">gap_map2007</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span> <span class="co">#&lt;--RESTORE THIS TO 2007 (OUR DEFAULT YEAR).</span></span>
<span>    </span>
<span>    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">unname</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>     <span class="co">#WE MOVE THE CODE MAKING map_palette TO GLOBAL.R SO IT ONLY RUNS ONCE EVER.</span></span>
<span>    </span>
<span>    <span class="fu">leaflet</span><span class="op">(</span>options <span class="op">=</span> <span class="fu">tileOptions</span><span class="op">(</span>maxZoom <span class="op">=</span> <span class="fl">6</span>, minZoom <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>        weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        fillColor <span class="op">=</span> <span class="fu">map_palette</span><span class="op">(</span><span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>        fillOpacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        popup <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"County: "</span>,</span>
<span>                       <span class="va">gap_map2007</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                       <span class="st">"&lt;br&gt;Life Expectancy: "</span>,</span>
<span>                       <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span></span>
<span>        <span class="co"># label = lapply(1:nrow(gap_map2007), function(x) {</span></span>
<span>        <span class="co">#   HTML(</span></span>
<span>        <span class="co">#     paste0(</span></span>
<span>        <span class="co">#       "County: ",</span></span>
<span>        <span class="co">#       gap_map2007$country[x],</span></span>
<span>        <span class="co">#       "&lt;br&gt;Life Expectancy: ",</span></span>
<span>        <span class="co">#       gap_map2007$lifeExp[x]</span></span>
<span>        <span class="co">#     )</span></span>
<span>        <span class="co">#   )</span></span>
<span>        <span class="co"># })</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">setMaxBounds</span><span class="op">(</span><span class="va">bounds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bounds</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addLegend</span><span class="op">(</span></span>
<span>        position <span class="op">=</span> <span class="st">"bottomleft"</span>,</span>
<span>        pal <span class="op">=</span> <span class="va">map_palette</span>,</span>
<span>        values <span class="op">=</span> <span class="va">gap_map2007</span><span class="op">$</span><span class="va">lifeExp</span>,</span>
<span>        opacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        bins <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        title <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"Life&lt;br&gt;expectancy ("</span>, <span class="va">gap_map2007</span><span class="op">$</span><span class="va">year</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">###MAP OBSERVER (SLIDER)</span></span>
<span>  <span class="co">#A NEW OBSERVER WATCHES FOR EVENTS INVOLVING OUR NEW SLIDER.</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">year_slider</span>, <span class="op">{</span></span>
<span>    <span class="va">gap_map</span> <span class="op">=</span> <span class="va">gap_map</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--NOTE THE NAME CHANGE OF THE PRODUCT HERE.</span></span>
<span>      <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fu">as.numeric</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">year_slider</span><span class="op">)</span><span class="op">)</span> <span class="co">#&lt;--SLOT THAT SLIDER'S INPUT OBJECT HERE.</span></span>
<span>    </span>
<span>  <span class="co">#WE USE leafletProxy({}) TO UPDATE OUR MAP INSTEAD OF RE-RENDERING IT. </span></span>
<span>    <span class="fu">leafletProxy</span><span class="op">(</span><span class="st">"basic_map"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="co">#WE DON'T HAVE TO MESS WITH THE ZOOM, BOUNDS, OR TILES BECAUSE THOSE ASPECTS AREN'T CHANGING. </span></span>
<span>      <span class="fu">clearMarkers</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--WE DO NEED TO REMOVE THE OLD MARKERS THOUGH BECAUSE THEIR COLORS WILL CHANGE.</span></span>
<span>      <span class="fu">clearControls</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--SAME WITH THE LEGEND ("CONTROL") FOR THE SAME REASON.</span></span>
<span>      <span class="fu">addPolygons</span><span class="op">(</span> <span class="co">#&lt;--WE RE-BUILD OUR POLYGONS EXACTLY THE SAME AS ALWAYS...</span></span>
<span>        data <span class="op">=</span> <span class="va">gap_map</span><span class="op">$</span><span class="va">geometry</span>, <span class="co">#&lt;--EXCEPT WE REFERENCE gap_map THROUGHOUT.</span></span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>        weight <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        fillColor <span class="op">=</span> <span class="fu">map_palette</span><span class="op">(</span><span class="va">gap_map</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>        fillOpacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        popup <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"County: "</span>,</span>
<span>                       <span class="va">gap_map</span><span class="op">$</span><span class="va">country</span>,</span>
<span>                       <span class="st">"&lt;br&gt;Life Expectancy: "</span>,</span>
<span>                       <span class="va">gap_map</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span></span>
<span>        <span class="co"># label = lapply(1:nrow(gap_map), function(x) {</span></span>
<span>        <span class="co">#   HTML(</span></span>
<span>        <span class="co">#     paste0(</span></span>
<span>        <span class="co">#       "County: ",</span></span>
<span>        <span class="co">#       gap_map$country[x],</span></span>
<span>        <span class="co">#       "&lt;br&gt;Life Expectancy: ",</span></span>
<span>        <span class="co">#       gap_map$lifeExp[x]</span></span>
<span>        <span class="co">#     )</span></span>
<span>        <span class="co">#   )</span></span>
<span>        <span class="co"># })</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">addLegend</span><span class="op">(</span> <span class="co">#&lt;--WE RE-BUILD OUR LEGEND EXACTLY THE SAME WAY TOO. </span></span>
<span>        position <span class="op">=</span> <span class="st">"bottomleft"</span>,</span>
<span>        pal <span class="op">=</span> <span class="va">map_palette</span>,</span>
<span>        values <span class="op">=</span> <span class="va">gap_map</span><span class="op">$</span><span class="va">lifeExp</span>,</span>
<span>        opacity <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>        bins <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        title <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"Life&lt;br&gt;expectancy ("</span>, <span class="va">gap_map</span><span class="op">$</span><span class="va">year</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **added** to the bottom of your global.R file, after gap_map is made!</span></span>
<span></span>
<span><span class="co">###MAP COLOR PALETTE</span></span>
<span><span class="co">#WE MOVE THIS CODE TO GLOBAL.R SO IT NEED ONLY EVER RUN ONCE.</span></span>
<span><span class="va">map_palette</span> <span class="op">=</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span>, domain <span class="op">=</span> <span class="fu">unique</span><span class="op">(</span><span class="va">gap_map</span><span class="op">$</span><span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Since this overhaul was a little involved, let’s break down the key
pieces:</p>
<ol style="list-style-type: decimal"><li>
<p>First, for simplicity, we removed the code producing our
<code>map_palette</code> from <code>renderLeaflet({})</code>. Why? Now
that we will use this palette in two places, it’s more efficient to have
this code in <code>global.R</code> where it can run just once ever and
be reused whenever needed.</p>
<ul><li>This has the added benefit of ensuring every version of our map will
always use the exact same color-value mapping! Otherwise, our
<code>domain</code>s would shift, depending upon which year’s data are
being shown, making it harder to see patterns over time.</li>
</ul></li>
<li><p>We “strip back” the code in <code>renderLeaflet({})</code> such
that it contains no reactive objects (<em>e.g.</em>,
<code>input$year_slider</code>). As such, it’ll run once when the app
starts up but never again.</p></li>
<li><p>We create a new <code>observeEvent({},{})</code> watching our
slider. When it’s value changes, <code>leafletProxy()</code> will
dictate what happens.</p></li>
<li>
<p>We feed our proxy <em>only</em> commands affecting aspects that
<em>need</em> to change—in this case, we reference just our polygons and
legend (because their colors need to change).</p>
<ul><li><p>We first remove the old versions using <code>clear*()</code>
functions.</p></li>
<li><p>Then, we rebuild each exactly as we built them originally but
based on new data selected by the user.</p></li>
</ul></li>
</ol><p>Once you’ve made these changes, start the app and observe what
happens when you adjust the slider. You’ll hopefully notice that doing
so results in “smoother” updates than before.</p>
</div>
<div class="section level3">
<h3 id="watch-and-learn">Watch and learn<a class="anchor" aria-label="anchor" href="#watch-and-learn"></a></h3>
<p><code>leaflet</code> maps are <strong>widgets</strong> just like all
the rest we’ve seen, so information about user interactions with them
are being <em>constantly</em> passed from the UI to the server by
<code>input</code>. These data can be accessed using
<code>input$outputId_*</code> format.</p>
<p>For example, whenever a user <strong>double-clicks</strong> a
location, this is registered as a “double click event,” and we can
access information about that location using
<code>input$outputId_dblclick</code> format server-side. [There is
“single-click event tracking” too, but because our popups respond to
single clicks already, let’s consider double-clicks here.]</p>
<p>A cool feature of <code>leaflet</code> maps is <code>flyTo()</code>,
which will pan and zoom a map to center on a specific location.</p>
<p>Let’s combine these two features (<code>flyTo</code> plus
double-click event tracking)! Let’s create a new observer that watches
for double-clicks, and, when one happens, a <code>leafletProxy()</code>
centers the map on that location:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **added** to the bottom of your server.R file, but still within your server function!</span></span>
<span></span>
<span><span class="co">###MAP OBSERVER (DOUBLE CLICKS)</span></span>
<span><span class="co">#WE TRACK CHANGES IN THE DOUBLE-CLICK STATUS OF OUR MAP AND USE THAT INFO TO FLY TO THE LOCATION OF THE DOUBLE-CLICK.</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">basic_map_dblclick</span>, <span class="op">{</span></span>
<span>    <span class="fu">leafletProxy</span><span class="op">(</span><span class="st">"basic_map"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">flyTo</span><span class="op">(</span></span>
<span>        lat <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">basic_map_dblclick</span><span class="op">$</span><span class="va">lat</span>,</span>
<span>        lng <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">basic_map_dblclick</span><span class="op">$</span><span class="va">lng</span>,</span>
<span>        zoom <span class="op">=</span> <span class="fl">5</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="getting-graphic">Getting graphic<a class="anchor" aria-label="anchor" href="#getting-graphic"></a></h2>
<hr class="half-width"><p>We’ll now turn to <code>plotly</code>, a package for producing
graphs, similar to <code>ggplot2</code>, but that are
<em>interactive</em> <em>by design</em>.</p>
<p>Regular R users who know <code>ggplot2</code> know that learning a
graphics package is like learning a new language! The learning curve is
<em>significant</em>; these packages give users <em>all</em> the tools
needed to design an entire, complex graph piece by piece. That’s a lot
of tools to learn and to keep straight!</p>
<p><code>plotly</code> is no different—you can create ultra-detailed,
publication-quality graphics with <code>plotly</code> too, but you’ll
need to learn a new vernacular to do it, one that may feel similar to
<code>ggplot2</code> but probably not ultra-similar.</p>
<p>As such, covering <code>plotly</code> in depth is outside our scope
here. Thankfully, we actually don’t <em>need</em> to learn it;
<code>plotly</code> comes with an <em>incredible</em> “cheat code” that,
while imperfect, will work fine here: the <code>ggplotly()</code>
function.</p>
<p><code>ggplotly()</code> takes a fully realized <code>ggplot</code>,
breaks it down into pieces, and rebuilds it piece by piece in
<code>plotly</code>’s system (as best as it can). Because the two
systems are ultimately similar, you’ll get a similar-looking graph out
the end, but it’ll now have all the interactive features a scratch-built
<code>plotly</code> graph would have.</p>
<p>However, the two systems <em>don’t</em> map 1-to-1, so the result
will never look <em>exactly</em> the same as the input graph. In
particular, complex customizations using <code>ggplot</code>’s
<code>theme()</code>, text-related components, advanced or new features,
and so on don’t make the transition well.</p>
<p>So, it’s probably correct to say that <code>ggplotly</code> produces
a <code>plotly</code> graph in the spirit of the <code>ggplot2</code>
graph we put in, not an exact replica.</p>
<p>Still, that means we don’t need to learn how to produce a
<code>plotly</code> graph to explore the associated features and use
cases, so that’s a pretty good deal!</p>
<p>To get started, let’s build the <code>ggplot2</code> graph we’ll use
as an input. Let’s make it a scatterplot of GDP vs. population for a
given year (we’ll start by looking at 2007), with each continent getting
a different color. Additionally, we’ll plot a best-fit regression line
for each continent:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **added** to the bottom of your global.R file!</span></span>
<span></span>
<span><span class="co">###FILTERED DATA SET FOR MAP</span></span>
<span><span class="va">gap2007</span> <span class="op">=</span> <span class="va">gap</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span></span>
<span></span>
<span><span class="co">###BASE GGPLOT FOR CONVERSION TO PLOTLY</span></span>
<span><span class="co">#IF GGPLOT IS FAMILIAR TO YOU, STUDY THE SPECIFICS HERE TO GET A SENSE OF THE GRAPH WE'RE BUILDING. IF NOT, DON'T WORRY ABOUT THE DETAILS! JUST COPY-PASTE THIS CODE INTO PLACE.</span></span>
<span><span class="va">p1</span> <span class="op">=</span> <span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">gap2007</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu">log</span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="va">gdpPercap</span>,</span>
<span>    color <span class="op">=</span> <span class="va">continent</span>,</span>
<span>    group <span class="op">=</span> <span class="va">continent</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span></span>
<span>      size <span class="op">=</span> <span class="fl">16</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>      face <span class="op">=</span> <span class="st">"bold"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.line <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span><span class="st">"GDP per capita\n"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span><span class="st">"\nPopulation size (log)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span><span class="st">"Continent\n"</span><span class="op">)</span></span></code></pre>
</div>
<p>If you don’t know <code>ggplot2</code>, the above code will probably
look terrifying! No worries—just copy-paste the code and don’t worry too
much about what each piece does.</p>
<p>For those who <em>do</em> know <code>ggplot2</code>, you’ll hopefully
agree that, although this graph is not terrible remarkable, it looks
pretty good. More importantly, it’s just complex enough that it’ll be a
good test of how well <code>ggplotly()</code> does:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **added** to the bottom of your global.R file!</span></span>
<span><span class="va">p2</span> <span class="op">=</span> <span class="fu">ggplotly</span><span class="op">(</span><span class="va">p1</span><span class="op">)</span></span></code></pre>
</div>
<p>Now that we have our <code>plotly</code>-ized version of our graph,
it hopefully won’t surprise you to learn there are
<code>renderPlotly({})</code> and <code>plotlyOutput()</code> functions
we can use to add this graph to our app:</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **swapped** for the the "main panel" content in the BODY section of your ui.R file!</span></span>
<span></span>
<span><span class="co">##... other UI code...</span></span>
<span><span class="co">###MAIN PANEL CELL</span></span>
<span>    <span class="fu">column</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">8</span>, <span class="fu">tabsetPanel</span><span class="op">(</span></span>
<span>      <span class="co">###TABLE TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Table"</span>, <span class="fu">dataTableOutput</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="co">###MAP TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Map"</span>, <span class="fu">leafletOutput</span><span class="op">(</span><span class="st">"basic_map"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="co">###GRAPH TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Graph"</span>,</span>
<span>        <span class="fu">plotlyOutput</span><span class="op">(</span><span class="st">"basic_graph"</span><span class="op">)</span> <span class="co">#&lt;--ADD THE GRAPH HERE.</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##... other UI code...</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should be **added to** your server.R file, underneath all other contents inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">basic_graph</span> <span class="op">=</span> <span class="fu">renderPlotly</span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">p2</span> <span class="co">#Put our pre-built ggplotly() output here.</span></span>
<span>    </span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>If we launch our app, we should see our new <code>plotly</code> graph
on the Graph tab panel. It looks quite similar to our
<code>ggplot</code> graph!</p>
<p>The only difference I really notice is in the placement of the
legend; while <code>ggplot</code>s center their legends vertically in
the available space by default, <code>plotly</code> graphs top-align
them instead.</p>
<p>We’ll adjust that in a moment! Meanwhile, let’s focus on the new
interactive features this graph comes with out of the box (it’s a
lot!):</p>
<ul><li><p><strong>Tooltips</strong>: If you hover over a point, you’ll get
a <strong>tooltip</strong> showing the data point’s associated
<code>x</code>, <code>y</code>, and <code>group</code> (continent)
values. These tooltips don’t look “pretty” in a human-readability sense,
but that too is something we’ll soon change.</p></li>
<li><p><strong>Click+drag to zoom</strong>: If you click anywhere, drag
your cursor to highlight a region, and let go, you will zoom the graph
to only the highlighted region. Double-clicking will restore the
original zoom level.</p></li>
<li><p><strong>Interactive “modebar:”</strong> <code>plotly</code>
graphs come with a toolbar (called a “modebar”) in the top-right (when
hovering over the graph) featuring several buttons. These allow you to
download an image of the graph, zoom and pan, select specific data in
various ways, reset the graph in various ways, and change how the
tooltips work. In particular, click the “compare data on hover” button
and see how this changes the behavior of the tooltips!</p></li>
<li><p><strong>Legend group (de)selection</strong>: If you click any of
the legend keys (such as “Asia”), all the data points from that group
will be redacted, and the axes will readjust as though those data
weren’t present. Double-clicking a legend key will reduce the data shown
to <em>only</em> those from that group. This functionality might allow a
user to exclude data extraneous to them personally and to focus of data
that <em>are</em> of interest.</p></li>
</ul><p>That’s a lot of interactivity for minimal effort on our part!</p>
<div class="section level3">
<h3 id="more-or-less-basic-graph">More (or less) basic graph<a class="anchor" aria-label="anchor" href="#more-or-less-basic-graph"></a></h3>
<p>…which means it’s time to discuss how to disable features if we want.
Unfortunately, disabling features in <code>plotly</code> is not
<em>as</em> easy as in <code>DT</code> or <code>leaflet</code>; to do
so, we must engage with two of the core functions involved in assembly
of a scratch-made <code>plotly</code> graph: <code>layout()</code> and
<code>config()</code>.</p>
<p><code>layout()</code> is <em>sort of</em> equivalent to
<code>ggplot2</code>’s <code>theme()</code> in that it controls many of
the specifics of how the plot looks. Inside <code>layout()</code> are
<code>xaxis</code> and <code>yaxis</code> parameters, which we can
provide with specific instructions.</p>
<p>If we give both of these parameters a list containing the instruction
<code>fixedrange = TRUE</code>, this will prohibit zooming:</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the renderPlotly({}) code in your server.R file, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span><span class="co">###GRAPH</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_graph</span> <span class="op">=</span> <span class="fu">renderPlotly</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">p2</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">layout</span><span class="op">(</span> <span class="co">#&lt;--layout() ADJUSTS PLOTLY GRAPH AESTHETICS.</span></span>
<span>        <span class="co">#PLOTLY CODE LOOKS "JAVASCRIPT-LIKE" RATHER THAN "R-LIKE," HENCE LISTS!</span></span>
<span>        xaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        yaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>In my experience, most (but not all!) graphs don’t benefit from
zooming, and some users find it hard to figure out how to reverse an
accidental zoom.</p>
<p>We can also use <code>layout()</code> to adjust how the legend
responds to clicks. For example, if we want to turn off the
functionality that redacts a group when its legend key is clicked on, we
can set the <code>itemclick</code> instruction for the
<code>legend</code> parameter to <code>FALSE</code>:</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the renderPlotly({}) code in your server.R file, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span><span class="co">###GRAPH</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_graph</span> <span class="op">=</span> <span class="fu">renderPlotly</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">p2</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">layout</span><span class="op">(</span></span>
<span>        xaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        yaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        legend <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>          itemclick <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co">#&lt;--THE ONLY ADDITION--TURN OFF GROUP REDACTION UPON CLICKING ON LEGEND KEYS.</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">basic_graph</span> <span class="op">=</span> <span class="fu">renderPlotly</span><span class="op">(</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">p2</span> <span class="op">%&gt;%</span> </span>
<span>     <span class="fu">layout</span><span class="op">(</span>xaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            yaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            legend <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>itemclick <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="co">#&lt;-THE ONLY ADDITION HERE.</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>The <code>config()</code> function, meanwhile, can remove buttons
from the modebar, although you may need Google’s help to find the names
of the buttons you want to remove:</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the renderPlotly({}) code in your server.R file, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server </span></span>
<span><span class="co">###GRAPH</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_graph</span> <span class="op">=</span> <span class="fu">renderPlotly</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">p2</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">layout</span><span class="op">(</span></span>
<span>        xaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        yaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        legend <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>          itemclick <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">config</span><span class="op">(</span>modeBarButtonsToRemove <span class="op">=</span> <span class="fu">list</span><span class="op">(</span><span class="st">"lasso2d"</span><span class="op">)</span><span class="op">)</span> <span class="co">#&lt;--REMOVING THE "LASSO" SELECTION BUTTON.</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>As noted earlier, when considering UX, “less” can be “more.” If your
user might not understand it or won’t use it, remove it!</p>
<div class="section level4">
<h4 id="making-some-adjustments">Making some adjustments<a class="anchor" aria-label="anchor" href="#making-some-adjustments"></a></h4>
<p>Earlier, we identified two dissatisfying aspects of our graph. First,
the legend isn’t centered vertically, like in our original. Second, the
tooltip text could look nicer.</p>
<p>The first issue is easily solved using the <code>legend</code>
parameter inside of <code>layout()</code>, which we’ve already dabbled
with:</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the renderPlotly({}) code in your server.R file, inside of your server function!</span></span>
<span></span>
<span> <span class="co">##... other server code...</span></span>
<span><span class="co">###GRAPH</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_graph</span> <span class="op">=</span> <span class="fu">renderPlotly</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">p2</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">layout</span><span class="op">(</span></span>
<span>        xaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        yaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        legend <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>          itemclick <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>          y <span class="op">=</span> <span class="fl">0.5</span>, <span class="co">#&lt;--PUT THE LEGEND HALFWAY DOWN.</span></span>
<span>          yanchor <span class="op">=</span> <span class="st">"middle"</span> <span class="co">#&lt;--SPECIFICALLY, PUT THE **CENTER** HALFWAY DOWN.</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">config</span><span class="op">(</span>modeBarButtonsToRemove <span class="op">=</span> <span class="fu">list</span><span class="op">(</span><span class="st">"lasso2d"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>As for the second issue, the best way to beautify our tooltip
contents will be to use the <code>style()</code> function.</p>
<p>This is a multi-step process:</p>
<ol style="list-style-type: decimal"><li><p>First, let’s “pre-generate” the text we want to use in each
tooltip, (using the <code>dplyr</code> verb
<code>mutate()</code>).</p></li>
<li><p>Second, let’s pass this text through our <code>ggplot</code> call
so it gets packaged up with everything else being passed to
<code>ggplotly()</code>.</p></li>
<li><p>Lastly, let’s use <code>style()</code> to make the contents of
our tooltips <em>only</em> the custom text we’ve cooked up:</p></li>
</ol><div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the previous plotly-related code in your global.R file!</span></span>
<span></span>
<span> <span class="co">##... other global code...</span></span>
<span><span class="co">###FILTERED DATA SET FOR MAP</span></span>
<span><span class="va">gap2007</span> <span class="op">=</span> <span class="va">gap</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>tooltip_text <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span> <span class="co">#&lt;--HERE, WE GENERATE A NEW COLUMN CALLED tooltip_text USING paste0() THAT CONTAINS THE GDP AND POPULATION DATA IN A MORE READABLE FORMAT. </span></span>
<span>    <span class="st">"GDP: "</span>,</span>
<span>    <span class="fu">round</span><span class="op">(</span><span class="va">gdpPercap</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    <span class="st">"&lt;br&gt;"</span>,</span>
<span>    <span class="st">"Population: "</span>,</span>
<span>    <span class="fu">round</span><span class="op">(</span><span class="va">pop</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">###BASE GGPLOT FOR CONVERSION TO PLOTLY</span></span>
<span><span class="va">p1</span> <span class="op">=</span> <span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="va">gap2007</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu">log</span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="va">gdpPercap</span>,</span>
<span>    color <span class="op">=</span> <span class="va">continent</span>,</span>
<span>    group <span class="op">=</span> <span class="va">continent</span>,</span>
<span>    text <span class="op">=</span> <span class="va">tooltip_text</span> <span class="co">#&lt;--HERE, WE PASS OUR CUSTOM TOOLTIP TEXT IN AS AN AESTHETIC. EVEN THOUGH OUR GGPLOT NEVER USES THIS INFO, IT'LL BE PASSED ALONG TO OUR PLOTLY GRAPH BY ggplotly(). </span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span></span>
<span>      size <span class="op">=</span> <span class="fl">16</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>      face <span class="op">=</span> <span class="st">"bold"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.line <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span><span class="st">"GDP per capita\n"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span><span class="st">"\nPopulation size (log)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span><span class="st">"Continent\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">###PLOTLY CONVERSION</span></span>
<span><span class="va">p2</span> <span class="op">=</span> <span class="fu">ggplotly</span><span class="op">(</span><span class="va">p1</span>, </span>
<span>              tooltip <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--HERE, WE TELL GGPLOTLY() TO POPULATE TOOLTIPS WITH OUR CUSTOM TEXT AESTHETICS. </span></span>
<span>  <span class="fu">style</span><span class="op">(</span>hoverinfo <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span> <span class="co">#&lt;--HERE, WE USE style() TO ASK THAT TOOLTIPS CONTAIN ONLY THE CUSTOM TEXT PROVIDED--OTHERWISE, WE'LL GET OURS PLUS THE DEFAULT ONES!</span></span></code></pre>
</div>
<p>Now those tooltips are looking great!</p>
<p>Between <code>layout()</code>, <code>style()</code>, and
<code>config()</code>, you can adjust virtually any aspect of a
<code>plotly</code> graph to meet your desires, much as you can use
various <code>ggplot2</code> functions to customize your
<code>ggplot</code>s. It just may require some Googling and
experimentation to figure out <em>exactly</em> how to do it.</p>
</div>
</div>
<div class="section level3">
<h3 id="update-dont-remake-plotly-edition">Update, don’t remake, <code>plotly</code> edition!<a class="anchor" aria-label="anchor" href="#update-dont-remake-plotly-edition"></a></h3>
<p>Once again, it’s time to see how to update a <code>plotly</code>
graph “on the fly” in response to user actions without re-rendering the
whole thing!</p>
<p>That means first giving users a means of affecting the graph beyond
what the graph itself already provides. Let’s create a drop-down
selector that lets users pick a new color scheme:</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode r" tabindex="0"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="do">##This code should **replace** the "sidebar panel" cell's content within the BODY section of your ui.R file!</span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a><span class="do">##... other UI code...</span></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="do">###SIDEBAR CELL</span></span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>    <span class="fu">column</span>(</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>      <span class="at">width =</span> <span class="dv">4</span>,</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>      <span class="fu">selectInput</span>(</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"sorted_column"</span>,</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Select a column to sort the table by."</span>,</span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a>        <span class="at">choices =</span> <span class="fu">c</span>(</span>
<span id="cb39-11"><a href="#cb39-11" tabindex="-1"></a>          <span class="st">"Country"</span> <span class="ot">=</span> <span class="st">"country"</span>,</span>
<span id="cb39-12"><a href="#cb39-12" tabindex="-1"></a>          <span class="st">"Continent"</span> <span class="ot">=</span> <span class="st">"continent"</span>,</span>
<span id="cb39-13"><a href="#cb39-13" tabindex="-1"></a>          <span class="st">"Year"</span> <span class="ot">=</span> <span class="st">"year"</span>,</span>
<span id="cb39-14"><a href="#cb39-14" tabindex="-1"></a>          <span class="st">"Life expectancy"</span> <span class="ot">=</span> <span class="st">"lifeExp"</span>,</span>
<span id="cb39-15"><a href="#cb39-15" tabindex="-1"></a>          <span class="st">"Population size"</span> <span class="ot">=</span> <span class="st">"pop"</span>,</span>
<span id="cb39-16"><a href="#cb39-16" tabindex="-1"></a>          <span class="st">"GDP per capita"</span> <span class="ot">=</span> <span class="st">"gdpPercap"</span></span>
<span id="cb39-17"><a href="#cb39-17" tabindex="-1"></a>        )</span>
<span id="cb39-18"><a href="#cb39-18" tabindex="-1"></a>      ),</span>
<span id="cb39-19"><a href="#cb39-19" tabindex="-1"></a>      <span class="fu">actionButton</span>(<span class="at">inputId =</span> <span class="st">"go_button"</span>, <span class="at">label =</span> <span class="st">"Go!"</span>),</span>
<span id="cb39-20"><a href="#cb39-20" tabindex="-1"></a>    <span class="co"># actionButton(inputId = "reset_button",</span></span>
<span id="cb39-21"><a href="#cb39-21" tabindex="-1"></a>      <span class="co">#                   label = "Reset!"),</span></span>
<span id="cb39-22"><a href="#cb39-22" tabindex="-1"></a>      <span class="fu">sliderInput</span>(</span>
<span id="cb39-23"><a href="#cb39-23" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"year_slider"</span>,</span>
<span id="cb39-24"><a href="#cb39-24" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Pick what year's data are shown in the map."</span>,</span>
<span id="cb39-25"><a href="#cb39-25" tabindex="-1"></a>        <span class="at">value =</span> <span class="dv">2007</span>,</span>
<span id="cb39-26"><a href="#cb39-26" tabindex="-1"></a>        <span class="at">min =</span> <span class="fu">min</span>(gap<span class="sc">$</span>year),</span>
<span id="cb39-27"><a href="#cb39-27" tabindex="-1"></a>        <span class="at">max =</span> <span class="fu">max</span>(gap<span class="sc">$</span>year),</span>
<span id="cb39-28"><a href="#cb39-28" tabindex="-1"></a>        <span class="at">step =</span> <span class="dv">5</span>,</span>
<span id="cb39-29"><a href="#cb39-29" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">""</span></span>
<span id="cb39-30"><a href="#cb39-30" tabindex="-1"></a>      ),</span>
<span id="cb39-31"><a href="#cb39-31" tabindex="-1"></a>      <span class="fu">selectInput</span>(  <span class="co">#&lt;--ADD IN A COLOR SCHEME SELECTOR</span></span>
<span id="cb39-32"><a href="#cb39-32" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"color_scheme"</span>,</span>
<span id="cb39-33"><a href="#cb39-33" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Pick a color scheme for the graph."</span>,</span>
<span id="cb39-34"><a href="#cb39-34" tabindex="-1"></a>        <span class="at">choices =</span> <span class="fu">c</span>(<span class="st">"viridis"</span>, <span class="st">"plasma"</span>, <span class="st">"magma"</span>)</span>
<span id="cb39-35"><a href="#cb39-35" tabindex="-1"></a>      )</span>
<span id="cb39-36"><a href="#cb39-36" tabindex="-1"></a>    ),</span>
<span id="cb39-37"><a href="#cb39-37" tabindex="-1"></a><span class="do">##... other UI code...</span></span></code></pre>
</div>
<p>In <code>plotly</code>, the color scheme is generally specified
inside the <code>plot_ly()</code> call (the equivalent of
<code>ggplot()</code>) or inside an <code>add_*()</code> function call
(the equivalents of <code>geom</code>s in <code>ggplot2</code>).
However, one can be specified or modified using <code>style()</code>
too.</p>
<p>To update rather than remake our graph, we’ll use the
<code>plotly</code> functions <code>plotlyProxy()</code> and
<code>plotlyProxyInvoke()</code>, which are a like
<code>dataTableProxy()</code> and its helper functions like
<code>replaceData()</code> in that they are a “package deal;” both are
needed to accomplish the task. Specifically, we’ll use the
<code>"restyle"</code> method inside <code>plotProxyInvoke()</code> to
trigger a re-styling of the graph.</p>
<p>As in previous examples, we’ll also need to separate the
<code>renderPlotly({})</code> call that makes our original, default
graph from a new observer that watches <code>input$color_scheme</code>
and triggers restyling using <code>plotlyProxy()</code>. Let’s see all
these pieces in action:</p>
<div class="codewrapper sourceCode" id="cb40">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** all your plotly-related code to date in your server.R file!</span></span>
<span></span>
<span><span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">##ALL OUR renderPlotly({}) call will now do is make a "base" version of the graph.</span></span>
<span><span class="co">###GRAPH</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">basic_graph</span> <span class="op">=</span> <span class="fu">renderPlotly</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">p2</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">layout</span><span class="op">(</span></span>
<span>        xaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        yaxis <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>fixedrange <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        legend <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>          itemclick <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>          y <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>          yanchor <span class="op">=</span> <span class="st">"middle"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">config</span><span class="op">(</span>modeBarButtonsToRemove <span class="op">=</span> <span class="fu">list</span><span class="op">(</span><span class="st">"lasso2d"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">###GRAPH OBSERVER (COLOR SCHEME SELECTOR)</span></span>
<span><span class="co">#A NEW OBSERVER WILL WATCH FOR CHANGES TO OUR INPUT WIDGET.</span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">color_scheme</span>, <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co">#WE "BORROW" LEAFLET'S colorFactor() TO DESIGN AN APPROPRIATE COLOR SCHEME GIVEN THE USER'S SELECTION.</span></span>
<span>    <span class="va">new_pal</span> <span class="op">=</span> <span class="fu">colorFactor</span><span class="op">(</span>palette <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">color_scheme</span>,</span>
<span>                          domain <span class="op">=</span> <span class="va">gap2007</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">plotlyProxy</span><span class="op">(</span><span class="st">"basic_graph"</span>, <span class="va">session</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#&lt;--plotlyProxy() JUST NEEDS WHICH GRAPH (OF POTENTIALLY MANY) TO UPDATE.</span></span>
<span>      <span class="fu">plotlyProxyInvoke</span><span class="op">(</span><span class="st">"restyle"</span>, <span class="fu">list</span><span class="op">(</span>marker <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>        color <span class="op">=</span> <span class="fu">new_pal</span><span class="op">(</span><span class="va">gap2007</span><span class="op">$</span><span class="va">continent</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">11.3</span></span>
<span>      <span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="co">#&lt;--INPUTS TO plotProxyInvoke() INCLUDE A METHOD (HERE, "RESTYLE"), A LIST OF LISTS (WHAT STUFF TO CHANGING AND HOW), AND A LIST OF TRACES BEING CHANGED (HERE, ALL FIVE WE HAD BEFORE).</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>The first input to <code>plotlyProxyInvoke()</code> is a method name.
Here, we’re using <code>"restyle"</code> to adjust things the
<code>style()</code> function would regulate, such as the graph’s color
scheme. There’s also a <code>"relayout"</code> method for adjusting
things that <code>layout()</code> controls, such as the legend.</p>
<p>The second input is a list of lists—this is another place where we’re
<em>very nearly</em> writing JavaScript code, because if there’s one
thing JS loves, it’s lists! Each aspect we want to restyle gets named
(here, <code>marker</code>s are the only thing we want to restyle.</p>
<p>Then, we give each named aspect a list of inputs—what features do we
want to change about that aspect of the graph? Here, we’re changing the
<code>color</code>s, setting them equal to the new colors we’ve
generated using <code>colorFactor()</code> from
<code>leaflet</code>.</p>
<p>However, we also specify <code>size</code>s for these points. Why?
Because, if <code>plotlyProxy()</code> redraws our graph’s markers, it
will do so “from scratch,” using defaults for any properties we don’t
specify. Since our original graph featured custom-sized points, we need
to “override the default” size to arrive at the same size of points as
though we have before the restyle.</p>
<p>The last input to <code>plotlyProxyInvoke()</code> is a list of
<strong>trace numbers</strong>. A <code>plotly</code>
<strong>trace</strong> is one “set” of data being graphed. In our case,
we have five traces, one for each continent, and we’re modifying all
five, so you’d think we’d put <code>1:5</code> here.</p>
<p>However, JS starts counting all things at 0, not 1 (it’s a
“zero-indexed language,” whereas R is a “one-indexed language”), so we
specify <code>0:4</code> for this last input instead.</p>
<p>You’ll notice that, with this new proxy in place, our points change
colors as we adjust our new selector. However, our lines don’t, and our
legend keys also change to the wrong colors. These are fixable problems,
but not without <em>some</em> grief in our case—the TL:DR version is
that the graph conversion performed by <code>ggplotly()</code> comes
with baggage we’re running up against here. If we want to go further
down this route, we’d be better off rebuilding our graph in
<code>plotly</code>.</p>
</div>
<div class="section level3">
<h3 id="point-and-click"><strong>Point and click</strong><a class="anchor" aria-label="anchor" href="#point-and-click"></a></h3>
<p>As with all other widgets we’ve seen, user interactions with
<code>plotly</code> graphs can constitute events we can handle
server-side.</p>
<p>However, <code>plotly</code> is unusual in that info about these
events is <em>not</em> being passed automatically and constantly from
the UI to the server via <code>input</code>. Instead,
<code>plotly</code> has an alternative passing system that uses the
functions <code>event_register()</code> to specify which events to track
and <code>event_data()</code> to pass the relevant event data from the
UI to the server. This <em>sounds</em> a more complicated than what
we’re used to, but it’s really the same idea, just with more parts:</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the "main panel" cell's content within the BODY section of your ui.R file!</span></span>
<span></span>
<span><span class="co">##... other UI code...</span></span>
<span><span class="co">###MAIN PANEL CELL</span></span>
<span>    <span class="fu">column</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">8</span>, <span class="fu">tabsetPanel</span><span class="op">(</span></span>
<span>      <span class="co">###TABLE TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Table"</span>, <span class="fu">dataTableOutput</span><span class="op">(</span><span class="st">"basic_table"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="co">###MAP TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Map"</span>, <span class="fu">leafletOutput</span><span class="op">(</span><span class="st">"basic_map"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="co">###GRAPH TAB</span></span>
<span>      <span class="fu">tabPanel</span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Graph"</span>,</span>
<span>        <span class="fu">plotlyOutput</span><span class="op">(</span><span class="st">"basic_graph"</span><span class="op">)</span>,</span>
<span>        <span class="fu">textOutput</span><span class="op">(</span><span class="st">"point_clicked"</span><span class="op">)</span> <span class="co">#&lt;--ADD AN OUTPUT REPORTING DATA ON WHAT'S BEEN CLICKED.</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##... other UI code...</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb42">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **replace** the ggplotly() call within your global.R file!</span></span>
<span></span>
<span><span class="co">##... other global code...</span></span>
<span><span class="co">###PLOTLY CONVERSION</span></span>
<span><span class="va">p2</span> <span class="op">=</span> <span class="fu">ggplotly</span><span class="op">(</span><span class="va">p1</span>, tooltip <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>              source <span class="op">=</span> <span class="st">"our_graph"</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">#&lt;--PLOTLY EVENT TRACKING USES A SPECIAL ATTRIBUTE CALLED "SOURCE."</span></span>
<span>  <span class="fu">event_register</span><span class="op">(</span><span class="st">"plotly_click"</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">##&lt;--WATCH THIS GRAPH FOR USER CLICKS, SPECIFICALLY.</span></span>
<span>  <span class="fu">style</span><span class="op">(</span>hoverinfo <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##This code should **added to** the bottom of your server.R file, within the server function!</span></span>
<span></span>
<span><span class="co">##... other server code...</span></span>
<span></span>
<span><span class="co">#WE USE EVENT_DATA() LIKE input HERE, SPECIFYING WHICH GRAPH AND EVENT TO WATCH FOR.</span></span>
<span><span class="fu">observeEvent</span><span class="op">(</span><span class="fu">event_data</span><span class="op">(</span>event <span class="op">=</span> <span class="st">"plotly_click"</span>, source <span class="op">=</span> <span class="st">"our_graph"</span><span class="op">)</span>, <span class="op">{</span></span>
<span>    <span class="va">output</span><span class="op">$</span><span class="va">point_clicked</span> <span class="op">=</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="fu">paste0</span><span class="op">(</span></span>
<span>        <span class="st">"The exact GDP per capita value for this point is: "</span>,</span>
<span>        <span class="fu">event_data</span><span class="op">(</span>event <span class="op">=</span> <span class="st">"plotly_click"</span>, source <span class="op">=</span> <span class="st">"our_graph"</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="co">#&lt;--WE ACCESS THE EXACT Y VALUE OF THE POINT CLICKED LIKE THIS.</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>In this setup, we are creating something equivalent to
<code>input</code>—but the values being passed by this new thing are
related only to our graph and only to specific events we’ve
designated.</p>
<p>We’ve also had to give our graph a new “nickname” for use in just
this system: a <code>source</code> attribute, which we set to
<code>our_graph</code>. This really is not much different from how we
specify and use <code>inputId</code>s as nicknames when interfacing with
<code>input</code>, except that <code>source</code> values don’t double
as CSS <code>id</code>s.</p>
<p>We also had to specify what type of event we want to watch:
<code>plotly_clicks</code>. For whatever reason, <code>plotly</code>
graphs don’t watch for all possible events, just those we specify.</p>
<p>Lastly, we watch our <code>event_data()</code> call, just like we
would watch <code>input$widget_name</code>, with our new observer.
Whenever an event triggers, we use <code>renderText({})</code> and
<code>textOutput()</code> to print into the UI some specific information
about the point clicked. This is not a very exciting use of this
functionality, but it hopefully shows what’s possible.</p>
<p>So, ultimately, this system of event watching and handling is not
<em>much</em> harder the one used elsewhere in R Shiny apps involving
<code>input</code>; it’s more difficult only in that it’s different.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>The <code>DT</code>, <code>leaflet</code>, and <code>plotly</code>
packages can be used to produce web-ready, interactive tables, maps, and
graphs, respectively, for incorporation into Shiny apps.</li>
<li>Each of the graphics created by these packages come with tons of
interactive functionality out of the box. Because some of this
functionality might be confusing or unnecessary for all users, it’s
valuable to know you can adjust or disable any or all of these
features.</li>
<li>Any aesthetic component of these graphics can be adjusted or
customized, but the specifics of how to do this (and how easy or
intuitive it will be) will vary quite widely between packages and
aesthetics.</li>
<li>We should strive to update graphics, changing only the aspects that
need changing, rather than remaking graphics from scratch wherever
possible. This often means handling events using observers and proxies
rather than using <code>render*({})</code> functions.</li>
<li>Like with other widgets, user interactions with these graphics can
be tracked by the UI and passed to the server for handling. This passing
happens with the <code>input</code> object for <code>DT</code> and
<code>leaflet</code>, but an equivalent system must be used for
<code>plotly</code>.</li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/shiny_3.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/index.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/shiny_3.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: R Shiny's Core
        </a>
        <a class="chapter-link float-end" href="../instructor/index.html" rel="next">
          Home
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/carpentries/r_shiny_workshop/edit/main/episodes/shiny_4.Rmd" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/carpentries/r_shiny_workshop/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries/r_shiny_workshop/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries/r_shiny_workshop/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.6" class="external-link">sandpaper (0.16.6)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.6" class="external-link">pegboard (0.7.6)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.4" class="external-link">varnish (1.0.4)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries.github.io/r_shiny_workshop/instructor/shiny_4.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, r, The Carpentries",
  "name": "DTs and Leaflets and Plotlys, Oh my!",
  "creativeWorkStatus": "active",
  "url": "https://carpentries.github.io/r_shiny_workshop/instructor/shiny_4.html",
  "identifier": "https://carpentries.github.io/r_shiny_workshop/instructor/shiny_4.html",
  "dateCreated": "2024-07-10",
  "dateModified": "2024-08-29",
  "datePublished": "2024-09-03"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

